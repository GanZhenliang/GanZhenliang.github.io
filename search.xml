<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>ANN-Based Anomaly Detection</title>
      <link href="/2022/04/23/ANN-Based-Anomaly-Detection/"/>
      <url>/2022/04/23/ANN-Based-Anomaly-Detection/</url>
      
        <content type="html"><![CDATA[<h1 id="ANN-Based-Anomaly-Detection"><a href="#ANN-Based-Anomaly-Detection" class="headerlink" title="ANN-Based Anomaly Detection"></a>ANN-Based Anomaly Detection</h1><p>数据集：CIC-IDS2017</p><p>数据条数：250w 左右</p><p>数据特征：78</p><p>数据标签：14 攻击 + 1正常</p><p>使用三个线性层（Linear）</p><p><img src="/../image/ANN-Based-Anomaly-Detection/image-20220423185200426.png" class="lazyload" data-srcset="/../image/ANN-Based-Anomaly-Detection/image-20220423185200426.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220423185200426"></p><h2 id="Project文件结构"><a href="#Project文件结构" class="headerlink" title="Project文件结构"></a>Project文件结构</h2><div class="story post-story"><p><img src="/../image/ANN-Based-Anomaly-Detection/image-20220423185209476.png" class="lazyload" data-srcset="/../image/ANN-Based-Anomaly-Detection/image-20220423185209476.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220423185209476"></p></div><h2 id="Dataloder-py"><a href="#Dataloder-py" class="headerlink" title="Dataloder.py"></a>Dataloder.py</h2><div class="story post-story"><p>和CNN_Pytorch的Dataloder.py一样</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> preprocessing</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据file读取数据</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">readData</span>(<span class="params">file</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Loading raw data...&quot;</span>)</span><br><span class="line">    raw_data = pd.read_csv(file, header=<span class="literal">None</span>, low_memory=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">return</span> raw_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回需要清除的行数list</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">clearDirtyData</span>(<span class="params">df</span>):</span><br><span class="line">    dropList = df[(df[<span class="number">14</span>] == <span class="string">&quot;Nan&quot;</span>) | (df[<span class="number">15</span>] == <span class="string">&quot;Infinity&quot;</span>)].index.tolist()</span><br><span class="line">    <span class="keyword">return</span> dropList</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lookData</span>(<span class="params">raw_data</span>):</span><br><span class="line">    <span class="comment"># 打印数据集的标签数据数量</span></span><br><span class="line">    <span class="comment"># last_column_index = raw_data.shape[1] - 1</span></span><br><span class="line">    <span class="comment"># print(raw_data[last_column_index].value_counts())</span></span><br><span class="line">    <span class="comment"># 取出数据集标签部分</span></span><br><span class="line">    labels = raw_data.iloc[:, raw_data.shape[<span class="number">1</span>] - <span class="number">1</span>:]</span><br><span class="line">    <span class="comment"># 多维数组转为以为数组</span></span><br><span class="line">    labels = labels.values.ravel()</span><br><span class="line">    label_set = <span class="built_in">set</span>(labels)</span><br><span class="line">    <span class="keyword">return</span> label_set</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">separateData</span>(<span class="params">raw_data</span>):</span><br><span class="line">    lists = raw_data.values.tolist()</span><br><span class="line">    temp_lists = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">2</span>):</span><br><span class="line">        temp_lists.append([])</span><br><span class="line">    <span class="comment"># 得到raw_data的数据标签集合</span></span><br><span class="line">    label_set = lookData(raw_data)</span><br><span class="line">    <span class="comment"># 将无序的数据标签集合转换为有序的list</span></span><br><span class="line">    label_list = <span class="built_in">list</span>(label_set)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(lists)):</span><br><span class="line">        <span class="comment"># 得到所属标签的索引号</span></span><br><span class="line">        data_index = label_list.index(lists[i][<span class="built_in">len</span>(lists[<span class="number">0</span>]) - <span class="number">1</span>])</span><br><span class="line">        temp_lists[data_index].append(lists[i])</span><br><span class="line">    <span class="keyword">return</span> temp_lists</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DataLoder</span>():</span><br><span class="line">    acc_time = <span class="number">0</span></span><br><span class="line">    start = time.time()</span><br><span class="line">    data_1 = readData(</span><br><span class="line">        <span class="string">&quot;/data/GanZhenliang/PycharmProjects/Anomaly_Detection/data/MachineLearningCVE/Monday-WorkingHours.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_1 = data_1.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_2 = readData(</span><br><span class="line">        <span class="string">&quot;/data/GanZhenliang/PycharmProjects/Anomaly_Detection/data/MachineLearningCVE/Tuesday-WorkingHours.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_2 = data_2.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_3 = readData(</span><br><span class="line">        <span class="string">&quot;/data/GanZhenliang/PycharmProjects/Anomaly_Detection/data/MachineLearningCVE/Wednesday-workingHours.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_3 = data_3.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_4 = readData(</span><br><span class="line">        <span class="string">&quot;/data/GanZhenliang/PycharmProjects/Anomaly_Detection/data/MachineLearningCVE/Thursday-WorkingHours-Afternoon-Infilteration.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_4 = data_4.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_5 = readData(</span><br><span class="line">        <span class="string">&quot;/data/GanZhenliang/PycharmProjects/Anomaly_Detection/data/MachineLearningCVE/Thursday-WorkingHours-Morning-WebAttacks.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_5 = data_5.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_6 = readData(</span><br><span class="line">        <span class="string">&quot;/data/GanZhenliang/PycharmProjects/Anomaly_Detection/data/MachineLearningCVE/Friday-WorkingHours-Morning.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_6 = data_6.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_7 = readData(</span><br><span class="line">        <span class="string">&quot;/data/GanZhenliang/PycharmProjects/Anomaly_Detection/data/MachineLearningCVE/Friday-WorkingHours-Afternoon-DDos.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_7 = data_7.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_8 = readData(</span><br><span class="line">        <span class="string">&quot;/data/GanZhenliang/PycharmProjects/Anomaly_Detection/data/MachineLearningCVE/Friday-WorkingHours-Afternoon-PortScan.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_8 = data_8.drop([<span class="number">0</span>])</span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;数据加载时间：&#x27;</span>, end - start, <span class="string">&#x27;s&#x27;</span>)</span><br><span class="line">    acc_time += end - start</span><br><span class="line">    <span class="comment"># print(&#x27;开始处理数据&#x27;)</span></span><br><span class="line">    start = time.time()</span><br><span class="line">    temp = [data_1, data_2, data_3, data_4, data_5, data_6, data_7, data_8]</span><br><span class="line">    <span class="comment"># temp = [data_7, data_8]</span></span><br><span class="line">    data_all = pd.concat(temp)</span><br><span class="line">    data_list_clear = clearDirtyData(data_all)</span><br><span class="line">    data_all = data_all.drop(data_list_clear)</span><br><span class="line">    <span class="comment"># print(data_all[data_all.shape[1] - 1].value_counts())</span></span><br><span class="line"></span><br><span class="line">    data_all = data_all.sample(frac=<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(data_all[data_all.shape[<span class="number">1</span>] - <span class="number">1</span>].value_counts())</span><br><span class="line"></span><br><span class="line">    data_all[data_all.shape[<span class="number">1</span>] - <span class="number">1</span>], attacks = pd.factorize(data_all[data_all.shape[<span class="number">1</span>] - <span class="number">1</span>], sort=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># data_all[78][data_all[78] != 0] = 1</span></span><br><span class="line">    <span class="built_in">print</span>(data_all[data_all.shape[<span class="number">1</span>] - <span class="number">1</span>].value_counts())</span><br><span class="line">    <span class="comment"># ----------------------------------------降采样正常样本---------------------------------------</span></span><br><span class="line">    <span class="comment"># data_all[78][data_all[78] != 0] = 1</span></span><br><span class="line">    <span class="comment"># lists = separateData(data_all)</span></span><br><span class="line">    <span class="comment"># normal = pd.DataFrame(lists[0])</span></span><br><span class="line">    <span class="comment"># normal = normal.sample(frac=0.5)</span></span><br><span class="line">    <span class="comment"># abnormal = pd.DataFrame(lists[1])</span></span><br><span class="line">    <span class="comment"># temp = [normal, abnormal]</span></span><br><span class="line">    <span class="comment"># data_all = pd.concat(temp)</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># print(data_all[data_all.shape[1] - 1].value_counts())</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ----------------------------------------数据处理，标准化、归一化、等---------------------------------------</span></span><br><span class="line">    features = data_all.iloc[:, :data_all.shape[<span class="number">1</span>] - <span class="number">1</span>]</span><br><span class="line">    labels = data_all.iloc[:, data_all.shape[<span class="number">1</span>] - <span class="number">1</span>:]</span><br><span class="line">    <span class="comment"># 标准化.高斯分布(0,1)</span></span><br><span class="line">    <span class="comment"># features = preprocessing.scale(features)</span></span><br><span class="line">    <span class="comment"># 最小最大值标准化,最小0，最大1</span></span><br><span class="line">    features = preprocessing.minmax_scale(features, feature_range=(-<span class="number">3</span>, <span class="number">3</span>))</span><br><span class="line">    <span class="comment"># 归一化</span></span><br><span class="line">    <span class="comment"># features = preprocessing.normalize(features, norm=&quot;l2&quot;)</span></span><br><span class="line">    labels = labels.values.ravel()</span><br><span class="line">    <span class="comment"># labels[labels != 0] = 1</span></span><br><span class="line"></span><br><span class="line">    train_x, test_x, train_y, test_y = train_test_split(features, labels, test_size=<span class="number">0.3</span>)</span><br><span class="line">    <span class="comment"># train_x, test_x, train_y, test_y = train_test_split(features, Y_onehot, test_size=0.3)</span></span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;数据处理时间：&#x27;</span>, end - start, <span class="string">&#x27;s&#x27;</span>)</span><br><span class="line">    acc_time += end - start</span><br><span class="line">    <span class="keyword">return</span> train_x, test_x, train_y, test_y, acc_time</span><br></pre></td></tr></table></figure></div><h2 id="ANN-py"><a href="#ANN-py" class="headerlink" title="ANN.py"></a>ANN.py</h2><div class="story post-story"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torchvision</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> torch.utils.data <span class="keyword">as</span> Data</span><br><span class="line"><span class="keyword">from</span> Dataloder <span class="keyword">import</span> DataLoder</span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> metrics</span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> confusion_matrix</span><br><span class="line"></span><br><span class="line">epochs = <span class="number">100</span></span><br><span class="line">batch_size = <span class="number">128</span></span><br><span class="line">lr = <span class="number">0.001</span></span><br><span class="line"></span><br><span class="line">train_data, test_data, train_label, test_label, acc_time = DataLoder()</span><br><span class="line"><span class="comment"># 制作pytorch识别的数据集和定义模型</span></span><br><span class="line">train_data, train_label = torch.Tensor(train_data), torch.Tensor(train_label.T).long()</span><br><span class="line">test_data, test_label = torch.Tensor(test_data), torch.Tensor(test_label.T).long()</span><br><span class="line"></span><br><span class="line">train_dataset = Data.TensorDataset(train_data, train_label)</span><br><span class="line">test_dataset = Data.TensorDataset(test_data, test_label)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 制作Dataloder数据集，可迭代</span></span><br><span class="line">train_loader = Data.DataLoader(train_dataset, batch_size=batch_size, shuffle=<span class="literal">True</span>)</span><br><span class="line">test_loader = Data.DataLoader(test_dataset, batch_size=batch_size)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果是用gpu，就用gpu训练</span></span><br><span class="line">device = torch.device(<span class="string">&#x27;cuda:2&#x27;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line"><span class="comment"># 定义模型</span></span><br><span class="line">num_inputs, num_hiddens, num_outputs = <span class="number">78</span>, <span class="number">256</span>, <span class="number">15</span></span><br><span class="line"></span><br><span class="line">net = nn.Sequential(</span><br><span class="line">    nn.Linear(num_inputs, num_hiddens),</span><br><span class="line">    nn.ReLU(),</span><br><span class="line">    nn.Linear(num_hiddens, <span class="number">2</span> * num_hiddens),</span><br><span class="line">    nn.ReLU(),</span><br><span class="line">    nn.Linear(<span class="number">2</span> * num_hiddens, num_outputs)</span><br><span class="line">).to(device)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义损失函数</span></span><br><span class="line">loss = torch.nn.CrossEntropyLoss()</span><br><span class="line"><span class="comment"># 定义优化器</span></span><br><span class="line">optimizer = torch.optim.Adam(net.parameters(), lr=lr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 绘图</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pltfigure</span>(<span class="params">x, y, title, <span class="built_in">id</span>, data</span>):</span><br><span class="line">    plt.subplot(<span class="number">2</span>, <span class="number">2</span>, <span class="built_in">id</span>)</span><br><span class="line">    plt.plot(<span class="built_in">range</span>(<span class="built_in">len</span>(data)), data)</span><br><span class="line">    plt.xlabel(x)</span><br><span class="line">    plt.ylabel(y)</span><br><span class="line">    plt.title(title, fontsize=<span class="number">10</span>)</span><br><span class="line">    <span class="comment"># plt.show()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模型的训练损失（loss）和验证损失（val_loss），以及训练准确率（acc）和验证准确率（val_acc）可以使用绘图代码绘制出来</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">visualize</span>(<span class="params">loss, val_loss, acc, val_acc</span>):</span><br><span class="line">    epochs = <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(loss) + <span class="number">1</span>)</span><br><span class="line">    plt.plot(epochs, loss, <span class="string">&#x27;bo&#x27;</span>, label=<span class="string">&#x27;Training loss&#x27;</span>)</span><br><span class="line">    plt.plot(epochs, val_loss, <span class="string">&#x27;b&#x27;</span>, label=<span class="string">&#x27;Validation loss&#x27;</span>)</span><br><span class="line">    plt.title(<span class="string">&#x27;Training and validatio loss&#x27;</span>)</span><br><span class="line">    plt.xlabel(<span class="string">&#x27;Epochs&#x27;</span>)</span><br><span class="line">    plt.ylabel(<span class="string">&#x27;Loss&#x27;</span>)</span><br><span class="line">    plt.legend()</span><br><span class="line">    plt.savefig(<span class="string">&#x27;result_ANN_Pytorch_loss.png&#x27;</span>, bbox_inches=<span class="string">&#x27;tight&#x27;</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line">    plt.figure()</span><br><span class="line">    plt.plot(epochs, acc, <span class="string">&#x27;bo&#x27;</span>, label=<span class="string">&#x27;Training acc&#x27;</span>)</span><br><span class="line">    plt.plot(epochs, val_acc, <span class="string">&#x27;b&#x27;</span>, label=<span class="string">&#x27;Validation acc&#x27;</span>)</span><br><span class="line">    plt.title(<span class="string">&#x27;Training and validatio accuracy&#x27;</span>)</span><br><span class="line">    plt.legend()</span><br><span class="line">    plt.savefig(<span class="string">&#x27;result_ANN_Pytorch_acc.png&#x27;</span>, bbox_inches=<span class="string">&#x27;tight&#x27;</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Confusion_matrix_hp</span>(<span class="params">cm</span>):</span><br><span class="line">    cm = pd.DataFrame(cm)</span><br><span class="line">    sns.heatmap(cm, annot=<span class="literal">False</span>, cmap=<span class="string">&#x27;GnBu&#x27;</span>)</span><br><span class="line">    plt.xlabel(<span class="string">&#x27;Real Label&#x27;</span>)</span><br><span class="line">    plt.ylabel(<span class="string">&#x27;Predict Label&#x27;</span>)</span><br><span class="line">    plt.savefig(<span class="string">&#x27;Confusion_ANN_Pytorch.png&#x27;</span>, bbox_inches=<span class="string">&#x27;tight&#x27;</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train</span>():</span><br><span class="line">    net.train()</span><br><span class="line">    batch_loss, correct, total = <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span></span><br><span class="line">    <span class="keyword">for</span> data, label <span class="keyword">in</span> train_loader:</span><br><span class="line">        data, label = data.to(device), label.to(device)</span><br><span class="line">        net.zero_grad()</span><br><span class="line">        output = net(data)</span><br><span class="line">        l = loss(output, label)</span><br><span class="line">        l.backward()</span><br><span class="line">        optimizer.step()</span><br><span class="line"></span><br><span class="line">        predict_label = torch.argmax(output, dim=<span class="number">1</span>)</span><br><span class="line">        correct += torch.<span class="built_in">sum</span>(predict_label == label).cpu().item()</span><br><span class="line">        total += <span class="built_in">len</span>(label)</span><br><span class="line">        batch_loss += l.cpu().item()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> correct / total, batch_loss / <span class="built_in">len</span>(train_loader)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>():</span><br><span class="line">    net.<span class="built_in">eval</span>()</span><br><span class="line">    batch_loss, correct, total = <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span></span><br><span class="line">    predict = np.zeros((<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">    <span class="keyword">for</span> data, label <span class="keyword">in</span> test_loader:</span><br><span class="line">        data, label = data.to(device), label.to(device)</span><br><span class="line"></span><br><span class="line">        output = net(data)</span><br><span class="line">        batch_loss += loss(output, label).cpu().item()</span><br><span class="line">        predict_label = torch.argmax(output, dim=<span class="number">1</span>)</span><br><span class="line">        predict = np.append(predict, predict_label.data.cpu().numpy())</span><br><span class="line">        correct += torch.<span class="built_in">sum</span>(predict_label == label).cpu().item()</span><br><span class="line">        total += <span class="built_in">len</span>(label)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> correct / total, batch_loss / <span class="built_in">len</span>(test_loader), predict[<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主程序</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;training on: &#x27;</span>, device)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;batch_size:&#x27;</span>, batch_size)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;epochs:&#x27;</span>, epochs)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;learning_rate:&#x27;</span>, lr)</span><br><span class="line">    plt.figure()</span><br><span class="line"></span><br><span class="line">    train_acc_list, train_loss_list, val_acc_list, val_loss_list = [], [], [], []</span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(epochs):</span><br><span class="line">        train_acc, train_loss = train()</span><br><span class="line">        test_acc, test_loss, predict = test()</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;epoch %d:  train acc: %.2f%% train loss:%.4f,  test acc: %.2f%%, test loss:%.4f&#x27;</span></span><br><span class="line">              % (epoch, <span class="number">100</span> * train_acc, train_loss, <span class="number">100</span> * test_acc, test_loss))</span><br><span class="line"></span><br><span class="line">        train_acc_list.append(train_acc)</span><br><span class="line">        train_loss_list.append(train_loss)</span><br><span class="line">        val_acc_list.append(test_acc)</span><br><span class="line">        val_loss_list.append(test_loss)</span><br><span class="line"></span><br><span class="line">    test_y = np.array(test_label)</span><br><span class="line">    <span class="built_in">print</span>(metrics.classification_report(test_y, predict))  <span class="comment"># 最后一个epoch的报告</span></span><br><span class="line">    cm = confusion_matrix(test_y, predict)</span><br><span class="line">    Confusion_matrix_hp(cm)</span><br><span class="line">    <span class="comment"># 绘图</span></span><br><span class="line">    pltfigure(x=<span class="string">&#x27;epoch&#x27;</span>, y=<span class="string">&#x27;acc&#x27;</span>, title=<span class="string">&#x27;epoch-train_acc&#x27;</span>, <span class="built_in">id</span>=<span class="number">1</span>, data=train_acc_list)</span><br><span class="line">    pltfigure(x=<span class="string">&#x27;epoch&#x27;</span>, y=<span class="string">&#x27;loss&#x27;</span>, title=<span class="string">&#x27;epoch-train_loss&#x27;</span>, <span class="built_in">id</span>=<span class="number">2</span>, data=train_loss_list)</span><br><span class="line">    pltfigure(x=<span class="string">&#x27;epoch&#x27;</span>, y=<span class="string">&#x27;acc&#x27;</span>, title=<span class="string">&#x27;epoch-test_acc&#x27;</span>, <span class="built_in">id</span>=<span class="number">3</span>, data=val_acc_list)</span><br><span class="line">    pltfigure(x=<span class="string">&#x27;epoch&#x27;</span>, y=<span class="string">&#x27;loss&#x27;</span>, title=<span class="string">&#x27;epoch-test_loss&#x27;</span>, <span class="built_in">id</span>=<span class="number">4</span>, data=val_loss_list)</span><br><span class="line">    plt.tight_layout()</span><br><span class="line">    plt.savefig(<span class="string">&#x27;result_ANN_Pytorch.png&#x27;</span>, bbox_inches=<span class="string">&#x27;tight&#x27;</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line">    visualize(train_loss_list, val_loss_list, train_acc_list, val_acc_list)</span><br></pre></td></tr></table></figure></div><h2 id="结果："><a href="#结果：" class="headerlink" title="结果："></a>结果：</h2><div class="story post-story"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">epochs = <span class="number">100</span></span><br><span class="line">batch_size = <span class="number">128</span></span><br><span class="line">lr = <span class="number">0.001</span></span><br><span class="line">百分之一数据集</span><br><span class="line">训练集 <span class="number">70</span>%</span><br><span class="line">验证集 <span class="number">30</span>% </span><br></pre></td></tr></table></figure><h3 id="15分类"><a href="#15分类" class="headerlink" title="15分类"></a>15分类</h3><h4 id="正常样本太多，各种攻击样本数量也非常不平衡，混淆矩阵没有任何意义"><a href="#正常样本太多，各种攻击样本数量也非常不平衡，混淆矩阵没有任何意义" class="headerlink" title="正常样本太多，各种攻击样本数量也非常不平衡，混淆矩阵没有任何意义"></a>正常样本太多，各种攻击样本数量也非常不平衡，混淆矩阵没有任何意义</h4><p><img src="/../image/ANN-Based-Anomaly-Detection/Confusion_ANN_Pytorch.png" class="lazyload" data-srcset="/../image/ANN-Based-Anomaly-Detection/Confusion_ANN_Pytorch.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Confusion_ANN_Pytorch"></p><h4 id="准确率，loss曲线"><a href="#准确率，loss曲线" class="headerlink" title="准确率，loss曲线"></a>准确率，loss曲线</h4><p><img src="/../image/ANN-Based-Anomaly-Detection/result_ANN_Pytorch.png" class="lazyload" data-srcset="/../image/ANN-Based-Anomaly-Detection/result_ANN_Pytorch.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="result_ANN_Pytorch"></p><p><img src="/../image/ANN-Based-Anomaly-Detection/result_ANN_Pytorch_acc.png" class="lazyload" data-srcset="/../image/ANN-Based-Anomaly-Detection/result_ANN_Pytorch_acc.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="result_ANN_Pytorch_acc"></p><p><img src="/../image/ANN-Based-Anomaly-Detection/result_ANN_Pytorch_loss.png" class="lazyload" data-srcset="/../image/ANN-Based-Anomaly-Detection/result_ANN_Pytorch_loss.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="result_ANN_Pytorch_loss"></p><h4 id="最后一个Epoch分类结果"><a href="#最后一个Epoch分类结果" class="headerlink" title="最后一个Epoch分类结果"></a>最后一个Epoch分类结果</h4><table><thead><tr><th align="center"></th><th align="center"><strong>precision</strong></th><th align="center"><strong>recall</strong></th><th align="center"><strong>f1-score</strong></th><th align="center"><strong>support</strong></th></tr></thead><tbody><tr><td align="center">BENIGN</td><td align="center">0.99</td><td align="center">0.99</td><td align="center">0.99</td><td align="center">678355</td></tr><tr><td align="center">Bot</td><td align="center">0.58</td><td align="center">0.60</td><td align="center">0.59</td><td align="center">566</td></tr><tr><td align="center">DDoS</td><td align="center">1.00</td><td align="center">0.98</td><td align="center">0.99</td><td align="center">38051</td></tr><tr><td align="center">DoS  GoldenEye</td><td align="center">0.99</td><td align="center">0.96</td><td align="center">0.97</td><td align="center">3081</td></tr><tr><td align="center">DoS  Hulk</td><td align="center">0.99</td><td align="center">0.91</td><td align="center">0.95</td><td align="center">68930</td></tr><tr><td align="center">DoS  Slowhttptest</td><td align="center">0.88</td><td align="center">0.98</td><td align="center">0.93</td><td align="center">1654</td></tr><tr><td align="center">DoS  slowloris</td><td align="center">0.99</td><td align="center">0.96</td><td align="center">0.97</td><td align="center">1727</td></tr><tr><td align="center">FTP-Patator</td><td align="center">0.99</td><td align="center">0.96</td><td align="center">0.97</td><td align="center">2305</td></tr><tr><td align="center">Heartbleed</td><td align="center">0.75</td><td align="center">1.00</td><td align="center">0.86</td><td align="center">3</td></tr><tr><td align="center">Infiltration</td><td align="center">0.50</td><td align="center">0.11</td><td align="center">0.18</td><td align="center">9</td></tr><tr><td align="center">PortScan</td><td align="center">0.85</td><td align="center">0.99</td><td align="center">0.91</td><td align="center">46994</td></tr><tr><td align="center">SSH-Patator</td><td align="center">0.99</td><td align="center">0.57</td><td align="center">0.73</td><td align="center">1808</td></tr><tr><td align="center">Web  Attack Brute Force</td><td align="center">1.00</td><td align="center">0.06</td><td align="center">0.11</td><td align="center">449</td></tr><tr><td align="center">Web  Attack Sql  Injection</td><td align="center">0.00</td><td align="center">0.00</td><td align="center">0.00</td><td align="center">9</td></tr><tr><td align="center">Web  Attack XSS</td><td align="center">0.00</td><td align="center">0.00</td><td align="center">0.00</td><td align="center">199</td></tr><tr><td align="center">accuracy</td><td align="center"></td><td align="center"></td><td align="center"><strong>0.98</strong></td><td align="center">844140</td></tr><tr><td align="center">macro  avg</td><td align="center">0.77</td><td align="center">0.67</td><td align="center">0.68</td><td align="center">844140</td></tr><tr><td align="center">weighted  avg</td><td align="center">0.98</td><td align="center">0.98</td><td align="center">0.98</td><td align="center">844140</td></tr></tbody></table></div>]]></content>
      
      
      <categories>
          
          <category> 入侵检测 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Anomaly Detection </tag>
            
            <tag> 机器学习 </tag>
            
            <tag> ANN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CNN(Pytorch)-Based Anomaly Detection</title>
      <link href="/2022/04/21/CNN-Based-Anomaly-Detection/"/>
      <url>/2022/04/21/CNN-Based-Anomaly-Detection/</url>
      
        <content type="html"><![CDATA[<h1 id="CNN-Pytorch-Based-Anomaly-Detection"><a href="#CNN-Pytorch-Based-Anomaly-Detection" class="headerlink" title="CNN(Pytorch)-Based Anomaly Detection"></a>CNN(Pytorch)-Based Anomaly Detection</h1><p>数据集：CIC-IDS2017</p><p>数据条数：250w 左右</p><p>数据特征：78</p><p>数据标签：14 攻击 + 1正常</p><p>使用两个一维卷积接一个全连接层</p><p><img src="/../image/CNN-Based-Anomaly-Detection/image-20220423180524757.png" class="lazyload" data-srcset="/../image/CNN-Based-Anomaly-Detection/image-20220423180524757.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220423180524757"></p><h2 id="Project文件结构"><a href="#Project文件结构" class="headerlink" title="Project文件结构"></a>Project文件结构</h2><div class="story post-story"><p><img src="/../image/CNN-Based-Anomaly-Detection/image-20220421115433974.png" class="lazyload" data-srcset="/../image/CNN-Based-Anomaly-Detection/image-20220421115433974.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220421115433974"></p></div><h2 id="Dataloder-py"><a href="#Dataloder-py" class="headerlink" title="Dataloder.py"></a>Dataloder.py</h2><div class="story post-story"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> preprocessing</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据file读取数据</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">readData</span>(<span class="params">file</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Loading raw data...&quot;</span>)</span><br><span class="line">    raw_data = pd.read_csv(file, header=<span class="literal">None</span>, low_memory=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">return</span> raw_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回需要清除的行数list</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">clearDirtyData</span>(<span class="params">df</span>):</span><br><span class="line">    dropList = df[(df[<span class="number">14</span>] == <span class="string">&quot;Nan&quot;</span>) | (df[<span class="number">15</span>] == <span class="string">&quot;Infinity&quot;</span>)].index.tolist()</span><br><span class="line">    <span class="keyword">return</span> dropList</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lookData</span>(<span class="params">raw_data</span>):</span><br><span class="line">    <span class="comment"># 打印数据集的标签数据数量</span></span><br><span class="line">    <span class="comment"># last_column_index = raw_data.shape[1] - 1</span></span><br><span class="line">    <span class="comment"># print(raw_data[last_column_index].value_counts())</span></span><br><span class="line">    <span class="comment"># 取出数据集标签部分</span></span><br><span class="line">    labels = raw_data.iloc[:, raw_data.shape[<span class="number">1</span>] - <span class="number">1</span>:]</span><br><span class="line">    <span class="comment"># 多维数组转为以为数组</span></span><br><span class="line">    labels = labels.values.ravel()</span><br><span class="line">    label_set = <span class="built_in">set</span>(labels)</span><br><span class="line">    <span class="keyword">return</span> label_set</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">separateData</span>(<span class="params">raw_data</span>):</span><br><span class="line">    lists = raw_data.values.tolist()</span><br><span class="line">    temp_lists = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">2</span>):</span><br><span class="line">        temp_lists.append([])</span><br><span class="line">    <span class="comment"># 得到raw_data的数据标签集合</span></span><br><span class="line">    label_set = lookData(raw_data)</span><br><span class="line">    <span class="comment"># 将无序的数据标签集合转换为有序的list</span></span><br><span class="line">    label_list = <span class="built_in">list</span>(label_set)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(lists)):</span><br><span class="line">        <span class="comment"># 得到所属标签的索引号</span></span><br><span class="line">        data_index = label_list.index(lists[i][<span class="built_in">len</span>(lists[<span class="number">0</span>]) - <span class="number">1</span>])</span><br><span class="line">        temp_lists[data_index].append(lists[i])</span><br><span class="line">    <span class="keyword">return</span> temp_lists</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DataLoder</span>():</span><br><span class="line">    acc_time = <span class="number">0</span></span><br><span class="line">    start = time.time()</span><br><span class="line">    data_1 = readData(</span><br><span class="line">        <span class="string">&quot;/data/GanZhenliang/PycharmProjects/Anomaly_Detection/data/MachineLearningCVE/Monday-WorkingHours.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_1 = data_1.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_2 = readData(</span><br><span class="line">        <span class="string">&quot;/data/GanZhenliang/PycharmProjects/Anomaly_Detection/data/MachineLearningCVE/Tuesday-WorkingHours.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_2 = data_2.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_3 = readData(</span><br><span class="line">        <span class="string">&quot;/data/GanZhenliang/PycharmProjects/Anomaly_Detection/data/MachineLearningCVE/Wednesday-workingHours.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_3 = data_3.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_4 = readData(</span><br><span class="line">        <span class="string">&quot;/data/GanZhenliang/PycharmProjects/Anomaly_Detection/data/MachineLearningCVE/Thursday-WorkingHours-Afternoon-Infilteration.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_4 = data_4.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_5 = readData(</span><br><span class="line">        <span class="string">&quot;/data/GanZhenliang/PycharmProjects/Anomaly_Detection/data/MachineLearningCVE/Thursday-WorkingHours-Morning-WebAttacks.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_5 = data_5.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_6 = readData(</span><br><span class="line">        <span class="string">&quot;/data/GanZhenliang/PycharmProjects/Anomaly_Detection/data/MachineLearningCVE/Friday-WorkingHours-Morning.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_6 = data_6.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_7 = readData(</span><br><span class="line">        <span class="string">&quot;/data/GanZhenliang/PycharmProjects/Anomaly_Detection/data/MachineLearningCVE/Friday-WorkingHours-Afternoon-DDos.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_7 = data_7.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_8 = readData(</span><br><span class="line">        <span class="string">&quot;/data/GanZhenliang/PycharmProjects/Anomaly_Detection/data/MachineLearningCVE/Friday-WorkingHours-Afternoon-PortScan.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_8 = data_8.drop([<span class="number">0</span>])</span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;数据加载时间：&#x27;</span>, end - start, <span class="string">&#x27;s&#x27;</span>)</span><br><span class="line">    acc_time += end - start</span><br><span class="line">    <span class="comment"># print(&#x27;开始处理数据&#x27;)</span></span><br><span class="line">    start = time.time()</span><br><span class="line">    temp = [data_1, data_2, data_3, data_4, data_5, data_6, data_7, data_8]</span><br><span class="line">    <span class="comment"># temp = [data_7, data_8]</span></span><br><span class="line">    data_all = pd.concat(temp)</span><br><span class="line">    data_list_clear = clearDirtyData(data_all)</span><br><span class="line">    data_all = data_all.drop(data_list_clear)</span><br><span class="line">    <span class="comment"># print(data_all[data_all.shape[1] - 1].value_counts())</span></span><br><span class="line"></span><br><span class="line">    data_all = data_all.sample(frac=<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(data_all[data_all.shape[<span class="number">1</span>] - <span class="number">1</span>].value_counts())</span><br><span class="line"></span><br><span class="line">    data_all[data_all.shape[<span class="number">1</span>] - <span class="number">1</span>], attacks = pd.factorize(data_all[data_all.shape[<span class="number">1</span>] - <span class="number">1</span>], sort=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># data_all[78][data_all[78] != 0] = 1</span></span><br><span class="line">    <span class="built_in">print</span>(data_all[data_all.shape[<span class="number">1</span>] - <span class="number">1</span>].value_counts())</span><br><span class="line">    <span class="comment"># ----------------------------------------降采样正常样本---------------------------------------</span></span><br><span class="line">    <span class="comment"># data_all[78][data_all[78] != 0] = 1</span></span><br><span class="line">    <span class="comment"># lists = separateData(data_all)</span></span><br><span class="line">    <span class="comment"># normal = pd.DataFrame(lists[0])</span></span><br><span class="line">    <span class="comment"># normal = normal.sample(frac=0.5)</span></span><br><span class="line">    <span class="comment"># abnormal = pd.DataFrame(lists[1])</span></span><br><span class="line">    <span class="comment"># temp = [normal, abnormal]</span></span><br><span class="line">    <span class="comment"># data_all = pd.concat(temp)</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># print(data_all[data_all.shape[1] - 1].value_counts())</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ----------------------------------------数据处理，标准化、归一化、等---------------------------------------</span></span><br><span class="line">    features = data_all.iloc[:, :data_all.shape[<span class="number">1</span>] - <span class="number">1</span>]</span><br><span class="line">    labels = data_all.iloc[:, data_all.shape[<span class="number">1</span>] - <span class="number">1</span>:]</span><br><span class="line">    <span class="comment"># 标准化.高斯分布(0,1)</span></span><br><span class="line">    <span class="comment"># features = preprocessing.scale(features)</span></span><br><span class="line">    <span class="comment"># 最小最大值标准化,最小0，最大1</span></span><br><span class="line">    features = preprocessing.minmax_scale(features, feature_range=(-<span class="number">3</span>, <span class="number">3</span>))</span><br><span class="line">    <span class="comment"># 归一化</span></span><br><span class="line">    <span class="comment"># features = preprocessing.normalize(features, norm=&quot;l2&quot;)</span></span><br><span class="line">    labels = labels.values.ravel()</span><br><span class="line">    <span class="comment"># labels[labels != 0] = 1</span></span><br><span class="line"></span><br><span class="line">    train_x, test_x, train_y, test_y = train_test_split(features, labels, test_size=<span class="number">0.3</span>)</span><br><span class="line">    <span class="comment"># train_x, test_x, train_y, test_y = train_test_split(features, Y_onehot, test_size=0.3)</span></span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;数据处理时间：&#x27;</span>, end - start, <span class="string">&#x27;s&#x27;</span>)</span><br><span class="line">    acc_time += end - start</span><br><span class="line">    <span class="keyword">return</span> train_x, test_x, train_y, test_y, acc_time</span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(&quot;训练集和目标值&quot;, train_x, train_y)</span></span><br><span class="line">    <span class="comment"># print(&quot;测试集和目标值&quot;, test_x, test_y)</span></span><br></pre></td></tr></table></figure></div><h2 id="CNN-Pytorch-py"><a href="#CNN-Pytorch-py" class="headerlink" title="CNN_Pytorch.py"></a>CNN_Pytorch.py</h2><div class="story post-story"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torchvision</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> torch.utils.data <span class="keyword">as</span> Data</span><br><span class="line"><span class="keyword">from</span> Dataloder <span class="keyword">import</span> DataLoder</span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> metrics</span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> confusion_matrix</span><br><span class="line"></span><br><span class="line">epochs = <span class="number">100</span></span><br><span class="line">batch_size = <span class="number">128</span></span><br><span class="line">lr = <span class="number">0.001</span></span><br><span class="line"></span><br><span class="line">train_data, test_data, train_label, test_label, acc_time = DataLoder()</span><br><span class="line"></span><br><span class="line">train_data = train_data.reshape(train_data.shape[<span class="number">0</span>], <span class="number">1</span>, <span class="number">78</span>)</span><br><span class="line">test_data = test_data.reshape(test_data.shape[<span class="number">0</span>], <span class="number">1</span>, <span class="number">78</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 制作pytorch识别的数据集和定义模型</span></span><br><span class="line">train_data, train_label = torch.Tensor(train_data), torch.Tensor(train_label.T).long()</span><br><span class="line">test_data, test_label = torch.Tensor(test_data), torch.Tensor(test_label.T).long()</span><br><span class="line"></span><br><span class="line">train_dataset = Data.TensorDataset(train_data, train_label)</span><br><span class="line">test_dataset = Data.TensorDataset(test_data, test_label)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 制作Dataloder数据集，可迭代</span></span><br><span class="line">train_loader = Data.DataLoader(train_dataset, batch_size=<span class="number">128</span>, shuffle=<span class="literal">True</span>)</span><br><span class="line">test_loader = Data.DataLoader(test_dataset, batch_size=<span class="number">128</span>, shuffle=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CNN</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(CNN, self).__init__()</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        一般来说，卷积网络包括以下内容：</span></span><br><span class="line"><span class="string">        1.卷积层</span></span><br><span class="line"><span class="string">        2.神经网络</span></span><br><span class="line"><span class="string">        3.池化层</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        self.conv1 = nn.Sequential(</span><br><span class="line">            nn.Conv1d(</span><br><span class="line">                in_channels=<span class="number">1</span>,</span><br><span class="line">                out_channels=<span class="number">128</span>,</span><br><span class="line">                kernel_size=<span class="number">2</span>,</span><br><span class="line">                <span class="comment"># stride=1,</span></span><br><span class="line">                <span class="comment"># padding=1,  # 边框补全，其计算公式=（kernel_size-1）/2=(5-1)/2=2</span></span><br><span class="line">            ),</span><br><span class="line">            nn.BatchNorm1d(<span class="number">128</span>),  <span class="comment"># 使每一层神经网络的输入保持相同分布的</span></span><br><span class="line">            nn.ReLU(),  <span class="comment"># 非线性激活层</span></span><br><span class="line">            nn.MaxPool1d(kernel_size=<span class="number">2</span>),</span><br><span class="line">        )</span><br><span class="line">        self.conv2 = nn.Sequential(</span><br><span class="line">            nn.Conv1d(</span><br><span class="line">                in_channels=<span class="number">128</span>,</span><br><span class="line">                out_channels=<span class="number">32</span>,</span><br><span class="line">                kernel_size=<span class="number">2</span>,</span><br><span class="line">                <span class="comment"># stride=1,</span></span><br><span class="line">                <span class="comment"># padding=1,  # 边框补全，其计算公式=（kernel_size-1）/2=(5-1)/2=2</span></span><br><span class="line">            ),</span><br><span class="line">            nn.BatchNorm1d(<span class="number">32</span>),</span><br><span class="line">            nn.ReLU(),  <span class="comment"># 非线性激活层</span></span><br><span class="line">            nn.MaxPool1d(kernel_size=<span class="number">2</span>),</span><br><span class="line">        )</span><br><span class="line">        self.out = nn.Linear(<span class="number">576</span>, <span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = self.conv1(x)  <span class="comment"># 128,1,78  -&gt;  128 128 38</span></span><br><span class="line">        x = self.conv2(x)  <span class="comment"># 128 128 38 -&gt;  128 128 18</span></span><br><span class="line">        x = x.view(x.size(<span class="number">0</span>), -<span class="number">1</span>)  <span class="comment"># 128,576</span></span><br><span class="line">        output = self.out(x)</span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">device = torch.device(<span class="string">&#x27;cuda:1&#x27;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line">model = CNN()</span><br><span class="line">model = model.to(device)  <span class="comment"># 传到GPU</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义损失函数</span></span><br><span class="line">loss = torch.nn.CrossEntropyLoss()</span><br><span class="line"><span class="comment"># 定义优化器</span></span><br><span class="line">optimizer = torch.optim.Adam(model.parameters(), lr=<span class="number">0.001</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模型的训练损失（loss）和验证损失（val_loss），以及训练准确率（acc）和验证准确率（val_acc）可以使用绘图代码绘制出来</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">visualize</span>(<span class="params">loss, val_loss, acc, val_acc</span>):</span><br><span class="line">    epochs = <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(loss) + <span class="number">1</span>)</span><br><span class="line">    plt.plot(epochs, loss, <span class="string">&#x27;bo&#x27;</span>, label=<span class="string">&#x27;Training loss&#x27;</span>)</span><br><span class="line">    plt.plot(epochs, val_loss, <span class="string">&#x27;b&#x27;</span>, label=<span class="string">&#x27;Validation loss&#x27;</span>)</span><br><span class="line">    plt.title(<span class="string">&#x27;Training and validatio loss&#x27;</span>)</span><br><span class="line">    plt.xlabel(<span class="string">&#x27;Epochs&#x27;</span>)</span><br><span class="line">    plt.ylabel(<span class="string">&#x27;Loss&#x27;</span>)</span><br><span class="line">    plt.legend()</span><br><span class="line">    plt.savefig(<span class="string">&#x27;result_CNN_Pytorch_loss.png&#x27;</span>, bbox_inches=<span class="string">&#x27;tight&#x27;</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line">    plt.figure()</span><br><span class="line">    plt.plot(epochs, acc, <span class="string">&#x27;bo&#x27;</span>, label=<span class="string">&#x27;Training acc&#x27;</span>)</span><br><span class="line">    plt.plot(epochs, val_acc, <span class="string">&#x27;b&#x27;</span>, label=<span class="string">&#x27;Validation acc&#x27;</span>)</span><br><span class="line">    plt.title(<span class="string">&#x27;Training and validatio accuracy&#x27;</span>)</span><br><span class="line">    plt.legend()</span><br><span class="line">    plt.savefig(<span class="string">&#x27;result_CNN_Pytorch_acc.png&#x27;</span>, bbox_inches=<span class="string">&#x27;tight&#x27;</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 绘图</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pltfigure</span>(<span class="params">x, y, title, <span class="built_in">id</span>, data</span>):</span><br><span class="line">    plt.subplot(<span class="number">2</span>, <span class="number">2</span>, <span class="built_in">id</span>)</span><br><span class="line">    plt.plot(<span class="built_in">range</span>(<span class="built_in">len</span>(data)), data)</span><br><span class="line">    plt.xlabel(x)</span><br><span class="line">    plt.ylabel(y)</span><br><span class="line">    plt.title(title, fontsize=<span class="number">10</span>)</span><br><span class="line">    <span class="comment"># plt.show()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Confusion_matrix_hp</span>(<span class="params">cm</span>):</span><br><span class="line">    cm = pd.DataFrame(cm)</span><br><span class="line">    sns.heatmap(cm, annot=<span class="literal">False</span>, cmap=<span class="string">&#x27;GnBu&#x27;</span>)</span><br><span class="line">    plt.xlabel(<span class="string">&#x27;Real Label&#x27;</span>)</span><br><span class="line">    plt.ylabel(<span class="string">&#x27;Predict Label&#x27;</span>)</span><br><span class="line">    plt.savefig(<span class="string">&#x27;Confusion_CNN_Pytorch.png&#x27;</span>, bbox_inches=<span class="string">&#x27;tight&#x27;</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train</span>():</span><br><span class="line">    model.train()</span><br><span class="line">    batch_loss, correct, total = <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span></span><br><span class="line">    <span class="keyword">for</span> data, label <span class="keyword">in</span> train_loader:</span><br><span class="line">        data, label = data.to(device), label.to(device)</span><br><span class="line">        model.zero_grad()</span><br><span class="line">        output = model(data)</span><br><span class="line">        l = loss(output, label)</span><br><span class="line">        l.backward()</span><br><span class="line">        optimizer.step()</span><br><span class="line">        predict_label = torch.argmax(output, dim=<span class="number">1</span>)</span><br><span class="line">        correct += torch.<span class="built_in">sum</span>(predict_label == label).cpu().item()</span><br><span class="line">        total += <span class="built_in">len</span>(label)</span><br><span class="line">        batch_loss += l.cpu().item()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> correct / total, batch_loss / <span class="built_in">len</span>(train_loader)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>():</span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line">    batch_loss, correct, total = <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span></span><br><span class="line">    predict = np.zeros((<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">    <span class="keyword">for</span> data, label <span class="keyword">in</span> test_loader:</span><br><span class="line">        data, label = data.to(device), label.to(device)</span><br><span class="line">        output = model(data)</span><br><span class="line">        batch_loss += loss(output, label).cpu().item()</span><br><span class="line">        predict_label = torch.argmax(output, dim=<span class="number">1</span>)</span><br><span class="line">        predict = np.append(predict, predict_label.data.cpu().numpy())</span><br><span class="line">        correct += torch.<span class="built_in">sum</span>(predict_label == label).cpu().item()</span><br><span class="line">        total += <span class="built_in">len</span>(label)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> correct / total, batch_loss / <span class="built_in">len</span>(test_loader), predict[<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主程序</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;training on: &#x27;</span>, device)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;batch_size:&#x27;</span>, batch_size)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;epochs:&#x27;</span>, epochs)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;learning_rate:&#x27;</span>, lr)</span><br><span class="line">    <span class="comment"># plt.figure()</span></span><br><span class="line"></span><br><span class="line">    train_acc_list, train_loss_list, val_acc_list, val_loss_list = [], [], [], []</span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(epochs):</span><br><span class="line">        train_acc, train_loss = train()</span><br><span class="line">        test_acc, test_loss, predict = test()</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;epoch %d:  train acc: %.2f%% train loss:%.4f,  test acc: %.2f%%, test loss:%.4f&#x27;</span></span><br><span class="line">              % (epoch, <span class="number">100</span> * train_acc, train_loss, <span class="number">100</span> * test_acc, test_loss))</span><br><span class="line"></span><br><span class="line">        train_acc_list.append(train_acc)</span><br><span class="line">        train_loss_list.append(train_loss)</span><br><span class="line">        val_acc_list.append(test_acc)</span><br><span class="line">        val_loss_list.append(test_loss)</span><br><span class="line"></span><br><span class="line">    test_y = np.array(test_label)</span><br><span class="line">    <span class="built_in">print</span>(metrics.classification_report(test_y, predict))  <span class="comment"># 最后一个epoch的报告</span></span><br><span class="line">    cm = confusion_matrix(test_y, predict)</span><br><span class="line">    Confusion_matrix_hp(cm)</span><br><span class="line">    <span class="comment"># 绘图</span></span><br><span class="line">    pltfigure(x=<span class="string">&#x27;epoch&#x27;</span>, y=<span class="string">&#x27;acc&#x27;</span>, title=<span class="string">&#x27;epoch-train_acc&#x27;</span>, <span class="built_in">id</span>=<span class="number">1</span>, data=train_acc_list)</span><br><span class="line">    pltfigure(x=<span class="string">&#x27;epoch&#x27;</span>, y=<span class="string">&#x27;loss&#x27;</span>, title=<span class="string">&#x27;epoch-train_loss&#x27;</span>, <span class="built_in">id</span>=<span class="number">2</span>, data=train_loss_list)</span><br><span class="line">    pltfigure(x=<span class="string">&#x27;epoch&#x27;</span>, y=<span class="string">&#x27;acc&#x27;</span>, title=<span class="string">&#x27;epoch-val_acc&#x27;</span>, <span class="built_in">id</span>=<span class="number">3</span>, data=val_acc_list)</span><br><span class="line">    pltfigure(x=<span class="string">&#x27;epoch&#x27;</span>, y=<span class="string">&#x27;loss&#x27;</span>, title=<span class="string">&#x27;epoch-val_loss&#x27;</span>, <span class="built_in">id</span>=<span class="number">4</span>, data=val_loss_list)</span><br><span class="line">    plt.tight_layout()</span><br><span class="line">    plt.savefig(<span class="string">&#x27;result_CNN_Pytorch.png&#x27;</span>, bbox_inches=<span class="string">&#x27;tight&#x27;</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line">    visualize(train_loss_list, val_loss_list, train_acc_list, val_acc_list)</span><br></pre></td></tr></table></figure></div><h2 id="结果："><a href="#结果：" class="headerlink" title="结果："></a>结果：</h2><div class="story post-story"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">epochs = <span class="number">100</span></span><br><span class="line">batch_size = <span class="number">128</span></span><br><span class="line">lr = <span class="number">0.001</span></span><br><span class="line">百分之一数据集</span><br><span class="line">训练集 <span class="number">70</span>%</span><br><span class="line">验证集 <span class="number">30</span>% </span><br></pre></td></tr></table></figure><h3 id="二分类："><a href="#二分类：" class="headerlink" title="二分类："></a>二分类：</h3><h4 id="准确率，loss曲线"><a href="#准确率，loss曲线" class="headerlink" title="准确率，loss曲线"></a>准确率，loss曲线</h4><p><img src="/../image/CNN-Based-Anomaly-Detection/result_CNN_Pytorch.png" class="lazyload" data-srcset="/../image/CNN-Based-Anomaly-Detection/result_CNN_Pytorch.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="result_CNN_Pytorch"></p><h4 id="最后一个Epoch的报告，混淆矩阵："><a href="#最后一个Epoch的报告，混淆矩阵：" class="headerlink" title="最后一个Epoch的报告，混淆矩阵："></a>最后一个Epoch的报告，混淆矩阵：</h4><p><img src="/../image/CNN-Based-Anomaly-Detection/image-20220421133734280.png" class="lazyload" data-srcset="/../image/CNN-Based-Anomaly-Detection/image-20220421133734280.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220421133734280"></p><p><img src="/../image/CNN-Based-Anomaly-Detection/Confusion_CNN_Pytorch.png" class="lazyload" data-srcset="/../image/CNN-Based-Anomaly-Detection/Confusion_CNN_Pytorch.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Confusion_CNN_Pytorch"></p><h3 id="15分类"><a href="#15分类" class="headerlink" title="15分类"></a>15分类</h3><h4 id="正常样本太多，各种攻击样本数量也非常不平衡，混淆矩阵没有任何意义"><a href="#正常样本太多，各种攻击样本数量也非常不平衡，混淆矩阵没有任何意义" class="headerlink" title="正常样本太多，各种攻击样本数量也非常不平衡，混淆矩阵没有任何意义"></a>正常样本太多，各种攻击样本数量也非常不平衡，混淆矩阵没有任何意义</h4><p><img src="/../image/CNN-Based-Anomaly-Detection/Confusion_CNN_Pytorch-16507071375881.png" class="lazyload" data-srcset="/../image/CNN-Based-Anomaly-Detection/Confusion_CNN_Pytorch-16507071375881.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Confusion_CNN_Pytorch-16507071375881"></p><h4 id="准确率，loss曲线-1"><a href="#准确率，loss曲线-1" class="headerlink" title="准确率，loss曲线"></a>准确率，loss曲线</h4><p><img src="/../image/CNN-Based-Anomaly-Detection/result_CNN_Pytorch-16507072429582.png" class="lazyload" data-srcset="/../image/CNN-Based-Anomaly-Detection/result_CNN_Pytorch-16507072429582.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="result_CNN_Pytorch-16507072429582"></p><p><img src="/../image/CNN-Based-Anomaly-Detection/result_CNN_Pytorch_acc.png" class="lazyload" data-srcset="/../image/CNN-Based-Anomaly-Detection/result_CNN_Pytorch_acc.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="result_CNN_Pytorch_acc"></p><p><img src="/../image/CNN-Based-Anomaly-Detection/result_CNN_Pytorch_loss.png" class="lazyload" data-srcset="/../image/CNN-Based-Anomaly-Detection/result_CNN_Pytorch_loss.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="result_CNN_Pytorch_loss"></p><h4 id="最后一个Epoch分类结果"><a href="#最后一个Epoch分类结果" class="headerlink" title="最后一个Epoch分类结果"></a>最后一个Epoch分类结果</h4><table><thead><tr><th align="center"></th><th align="center"><strong>precision</strong></th><th align="center"><strong>recall</strong></th><th align="center"><strong>f1-score</strong></th><th align="center"><strong>support</strong></th></tr></thead><tbody><tr><td align="center">BENIGN</td><td align="center">0.99</td><td align="center">1.00</td><td align="center">0.99</td><td align="center">677804</td></tr><tr><td align="center">Bot</td><td align="center">1.00</td><td align="center">0.35</td><td align="center">0.52</td><td align="center">556</td></tr><tr><td align="center">DDoS</td><td align="center">1.00</td><td align="center">0.96</td><td align="center">0.98</td><td align="center">38298</td></tr><tr><td align="center">DoS  GoldenEye</td><td align="center">0.99</td><td align="center">0.96</td><td align="center">0.98</td><td align="center">3132</td></tr><tr><td align="center">DoS  Hulk</td><td align="center">0.98</td><td align="center">0.95</td><td align="center">0.97</td><td align="center">68882</td></tr><tr><td align="center">DoS  Slowhttptest</td><td align="center">0.99</td><td align="center">0.92</td><td align="center">0.95</td><td align="center">1625</td></tr><tr><td align="center">DoS  slowloris</td><td align="center">0.96</td><td align="center">0.99</td><td align="center">0.98</td><td align="center">1715</td></tr><tr><td align="center">FTP-Patator</td><td align="center">1.00</td><td align="center">0.99</td><td align="center">1.00</td><td align="center">2310</td></tr><tr><td align="center">Heartbleed</td><td align="center">1.00</td><td align="center">1.00</td><td align="center">1.00</td><td align="center">5</td></tr><tr><td align="center">Infiltration</td><td align="center">0.92</td><td align="center">0.71</td><td align="center">0.80</td><td align="center">17</td></tr><tr><td align="center">PortScan</td><td align="center">0.99</td><td align="center">1.00</td><td align="center">1.00</td><td align="center">47369</td></tr><tr><td align="center">SSH-Patator</td><td align="center">0.96</td><td align="center">0.87</td><td align="center">0.91</td><td align="center">1783</td></tr><tr><td align="center">Web  Attack Brute Force</td><td align="center">0.68</td><td align="center">0.95</td><td align="center">0.79</td><td align="center">438</td></tr><tr><td align="center">Web  Attack Sql  Injection</td><td align="center">0.00</td><td align="center">0.00</td><td align="center">0.00</td><td align="center">5</td></tr><tr><td align="center">Web  Attack XSS</td><td align="center">0.26</td><td align="center">0.03</td><td align="center">0.05</td><td align="center">201</td></tr><tr><td align="center">accuracy</td><td align="center"></td><td align="center"></td><td align="center"><strong>0.99</strong></td><td align="center">844140</td></tr><tr><td align="center">macro  avg</td><td align="center">0.85</td><td align="center">0.78</td><td align="center">0.79</td><td align="center">844140</td></tr><tr><td align="center">weighted  avg</td><td align="center">0.99</td><td align="center">0.76</td><td align="center">0.99</td><td align="center">844140</td></tr></tbody></table></div>]]></content>
      
      
      <categories>
          
          <category> 入侵检测 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Anomaly Detection </tag>
            
            <tag> CNN </tag>
            
            <tag> 机器学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>KNN(自己写)-Based Anomaly Detection</title>
      <link href="/2022/04/21/KNN(%E8%87%AA%E5%B7%B1%E5%86%99)-Based-Anomaly-Detection/"/>
      <url>/2022/04/21/KNN(%E8%87%AA%E5%B7%B1%E5%86%99)-Based-Anomaly-Detection/</url>
      
        <content type="html"><![CDATA[<h1 id="KNN-Based-Anomaly-Detection"><a href="#KNN-Based-Anomaly-Detection" class="headerlink" title="KNN-Based Anomaly Detection"></a>KNN-Based Anomaly Detection</h1><p>上一篇通过调用sklearn中的knn实现Anomaly Detection，听老师指正以及和同学讨论之后，觉得自己可能有点小偏差。</p><p>可能老师要求的做异常检测的KNN的正常的做法是：</p><ul><li>数据集划分，<strong>训练集全部用正常样本</strong>，测试集异常正常都有</li><li>散点图中的横坐标还是index，纵坐标是测试样本和<strong>正常样本的最小k个距离的平均</strong></li><li>这样，就可以通过，不断的取阈值来画出ROC曲线。每取一个阈值，阈值以上都判定为异常点，阈值以下判断为正常点，计算FPR和TPR</li><li>这样做不能通过调用函数来计算准确率，因为训练集只有一个类别</li></ul><p>其实就是基于异常的入侵检测系统，<strong>用正常样本学习训练正常的规律特征，如果遇到大于预设阈值的样本则认为是异常，判定为入侵。</strong></p><p>根据王伟老师上课讲解的，基于异常的入侵检测系统特点是：<strong>就两种类别，是不是异常。</strong>能检测出异常，但不知道是哪种异常。</p><p>好处是可以快速和有效的检测出入侵（异常）。</p><p>但是随着正常样本的增多，模型要不断进行学习和更新。</p><h2 id="Project文件结构"><a href="#Project文件结构" class="headerlink" title="Project文件结构"></a>Project文件结构</h2><div class="story post-story"><p><img src="/../image/KNN(%E8%87%AA%E5%B7%B1%E5%86%99)-Based-Anomaly-Detection/image-20220421102535742-16505112953691.png" class="lazyload" data-srcset="/../image/KNN(%E8%87%AA%E5%B7%B1%E5%86%99)-Based-Anomaly-Detection/image-20220421102535742-16505112953691.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220421102535742"></p></div><h2 id="Dataloder-py"><a href="#Dataloder-py" class="headerlink" title="Dataloder.py"></a>Dataloder.py</h2><div class="story post-story"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> preprocessing</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据file读取数据</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">readData</span>(<span class="params">file</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Loading raw data...&quot;</span>)</span><br><span class="line">    raw_data = pd.read_csv(file, header=<span class="literal">None</span>, low_memory=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">return</span> raw_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回需要清除的行数list</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">clearDirtyData</span>(<span class="params">df</span>):</span><br><span class="line">    dropList = df[(df[<span class="number">14</span>] == <span class="string">&quot;Nan&quot;</span>) | (df[<span class="number">15</span>] == <span class="string">&quot;Infinity&quot;</span>)].index.tolist()</span><br><span class="line">    <span class="keyword">return</span> dropList</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lookData</span>(<span class="params">raw_data</span>):</span><br><span class="line">    <span class="comment"># 打印数据集的标签数据数量</span></span><br><span class="line">    <span class="comment"># last_column_index = raw_data.shape[1] - 1</span></span><br><span class="line">    <span class="comment"># print(raw_data[last_column_index].value_counts())</span></span><br><span class="line">    <span class="comment"># 取出数据集标签部分</span></span><br><span class="line">    labels = raw_data.iloc[:, raw_data.shape[<span class="number">1</span>] - <span class="number">1</span>:]</span><br><span class="line">    <span class="comment"># 多维数组转为以为数组</span></span><br><span class="line">    labels = labels.values.ravel()</span><br><span class="line">    label_set = <span class="built_in">set</span>(labels)</span><br><span class="line">    <span class="keyword">return</span> label_set</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">separateData</span>(<span class="params">raw_data</span>):</span><br><span class="line">    lists = raw_data.values.tolist()</span><br><span class="line">    temp_lists = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">2</span>):</span><br><span class="line">        temp_lists.append([])</span><br><span class="line">    <span class="comment"># 得到raw_data的数据标签集合</span></span><br><span class="line">    label_set = lookData(raw_data)</span><br><span class="line">    <span class="comment"># 将无序的数据标签集合转换为有序的list</span></span><br><span class="line">    label_list = <span class="built_in">list</span>(label_set)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(lists)):</span><br><span class="line">        <span class="comment"># 得到所属标签的索引号</span></span><br><span class="line">        data_index = label_list.index(lists[i][<span class="built_in">len</span>(lists[<span class="number">0</span>]) - <span class="number">1</span>])</span><br><span class="line">        temp_lists[data_index].append(lists[i])</span><br><span class="line">    <span class="keyword">return</span> temp_lists</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DataLoder</span>():</span><br><span class="line">    acc_time = <span class="number">0</span></span><br><span class="line">    <span class="comment"># ----------------------------------------读取数据，合并到一个DataFrame---------------------------------------</span></span><br><span class="line">    start = time.time()</span><br><span class="line">    data_1 = readData(<span class="string">&quot;data\MachineLearningCVE\Monday-WorkingHours.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_1 = data_1.drop([<span class="number">0</span>])  <span class="comment"># 去掉非数值类型的第一行</span></span><br><span class="line"></span><br><span class="line">    data_2 = readData(<span class="string">&quot;data\MachineLearningCVE\Tuesday-WorkingHours.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_2 = data_2.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_3 = readData(<span class="string">&quot;data\MachineLearningCVE\Wednesday-workingHours.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_3 = data_3.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_4 = readData(<span class="string">&quot;data\MachineLearningCVE\Thursday-WorkingHours-Afternoon-Infilteration.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_4 = data_4.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_5 = readData(<span class="string">&quot;data\MachineLearningCVE\Thursday-WorkingHours-Morning-WebAttacks.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_5 = data_5.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_6 = readData(<span class="string">&quot;data\MachineLearningCVE\Friday-WorkingHours-Morning.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_6 = data_6.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_7 = readData(<span class="string">&quot;data\MachineLearningCVE\Friday-WorkingHours-Afternoon-DDos.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_7 = data_7.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_8 = readData(<span class="string">&quot;data\MachineLearningCVE\Friday-WorkingHours-Afternoon-PortScan.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_8 = data_8.drop([<span class="number">0</span>])</span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;数据加载时间：&#x27;</span>, end - start, <span class="string">&#x27;s&#x27;</span>)</span><br><span class="line">    acc_time += end - start</span><br><span class="line">    <span class="comment"># ----------------------------------------处理数据---------------------------------------</span></span><br><span class="line">    <span class="comment"># print(&#x27;开始处理数据&#x27;)</span></span><br><span class="line">    start = time.time()</span><br><span class="line">    temp = [data_1, data_2, data_3, data_4, data_5, data_6, data_7, data_8]</span><br><span class="line">    <span class="comment"># temp = [data_7, data_8]</span></span><br><span class="line">    data_all = pd.concat(temp)</span><br><span class="line">    <span class="comment"># 删除Nan和Infinity所在行</span></span><br><span class="line">    data_list_clear = clearDirtyData(data_all)</span><br><span class="line">    data_all = data_all.drop(data_list_clear)</span><br><span class="line">    <span class="built_in">print</span>(data_all[data_all.shape[<span class="number">1</span>] - <span class="number">1</span>].value_counts())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 数据量太大，可以降采样frac=抽取百分比,现在是百分之0.1</span></span><br><span class="line">    data_all = data_all.sample(frac=<span class="number">0.001</span>)</span><br><span class="line">    <span class="built_in">print</span>(data_all[data_all.shape[<span class="number">1</span>] - <span class="number">1</span>].value_counts())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 把最后一列lable转化为数值</span></span><br><span class="line">    data_all[data_all.shape[<span class="number">1</span>] - <span class="number">1</span>], attacks = pd.factorize(data_all[data_all.shape[<span class="number">1</span>] - <span class="number">1</span>], sort=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># data_all[78][data_all[78] != 0] = 1</span></span><br><span class="line">    <span class="comment"># print(data_all[data_all.shape[1] - 1].value_counts())</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ----------------------------------------划分正常，异常样本---------------------------------------</span></span><br><span class="line">    features = data_all.iloc[:, :data_all.shape[<span class="number">1</span>] - <span class="number">1</span>].values</span><br><span class="line">    labels = data_all.iloc[:, data_all.shape[<span class="number">1</span>] - <span class="number">1</span>:].values</span><br><span class="line">    <span class="comment"># 标准化.高斯分布(0,1)</span></span><br><span class="line">    features = preprocessing.scale(features)</span><br><span class="line">    <span class="comment"># 最小最大值标准化,最小0，最大1</span></span><br><span class="line">    <span class="comment"># features = preprocessing.minmax_scale(features)</span></span><br><span class="line">    <span class="comment"># 归一化</span></span><br><span class="line">    <span class="comment"># features = preprocessing.normalize(features, norm=&quot;l2&quot;)</span></span><br><span class="line">    data_all = np.c_[features, labels]</span><br><span class="line">    <span class="comment"># 变成二分类问题</span></span><br><span class="line">    data_all[:, <span class="number">78</span>][data_all[:, <span class="number">78</span>] != <span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">    data_all = pd.DataFrame(data_all)</span><br><span class="line">    lists = separateData(data_all)</span><br><span class="line">    normal = pd.DataFrame(lists[<span class="number">0</span>])</span><br><span class="line">    <span class="comment"># 取7/8的正常样本作为训练集，剩下的1/8和异常样本一起作为测试集</span></span><br><span class="line">    train = normal.iloc[<span class="number">0</span>:<span class="built_in">int</span>(normal.shape[<span class="number">0</span>] / <span class="number">8</span>) * <span class="number">7</span>, :]</span><br><span class="line">    normal = normal.iloc[<span class="built_in">int</span>(normal.shape[<span class="number">0</span>] / <span class="number">8</span>) * <span class="number">7</span>:normal.shape[<span class="number">0</span>], :]</span><br><span class="line">    abnormal = pd.DataFrame(lists[<span class="number">1</span>])</span><br><span class="line">    temp = [normal, abnormal]</span><br><span class="line">    data_all = pd.concat(temp)</span><br><span class="line">    data_all = data_all.sample(frac=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    test_x = data_all.iloc[:, :data_all.shape[<span class="number">1</span>] - <span class="number">1</span>].values</span><br><span class="line">    test_y = data_all.iloc[:, data_all.shape[<span class="number">1</span>] - <span class="number">1</span>:].values.ravel()</span><br><span class="line"></span><br><span class="line">    train_x = train.iloc[:, :data_all.shape[<span class="number">1</span>] - <span class="number">1</span>].values</span><br><span class="line">    train_y = train.iloc[:, data_all.shape[<span class="number">1</span>] - <span class="number">1</span>:].values.ravel()</span><br><span class="line"></span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;数据处理时间：&#x27;</span>, end - start, <span class="string">&#x27;s&#x27;</span>)</span><br><span class="line">    acc_time += end - start</span><br><span class="line">    <span class="keyword">return</span> train_x, test_x, train_y, test_y, acc_time</span><br></pre></td></tr></table></figure></div><h2 id="KNN-py"><a href="#KNN-py" class="headerlink" title="KNN.py"></a>KNN.py</h2><div class="story post-story"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">KNN</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, k</span>):</span><br><span class="line">        <span class="keyword">assert</span> k &gt;= <span class="number">1</span>, <span class="string">&#x27;k must be valid&#x27;</span></span><br><span class="line">        self.k = k</span><br><span class="line">        self._x_train = <span class="literal">None</span></span><br><span class="line">        self._y_train = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">fit</span>(<span class="params">self, x_train, y_train</span>):</span><br><span class="line">        self._x_train = x_train</span><br><span class="line">        self._y_train = y_train</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_predict</span>(<span class="params">self, x</span>):</span><br><span class="line">        d = [np.sqrt(np.<span class="built_in">sum</span>((x_i - x) ** <span class="number">2</span>)) <span class="keyword">for</span> x_i <span class="keyword">in</span> self._x_train]</span><br><span class="line">        nearest = np.argsort(d)</span><br><span class="line">        top_k = [self._y_train[i] <span class="keyword">for</span> i <span class="keyword">in</span> nearest[:self.k]]</span><br><span class="line">        votes = Counter(top_k)</span><br><span class="line">        <span class="keyword">return</span> votes.most_common(<span class="number">1</span>)[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">predict</span>(<span class="params">self, X_predict</span>):</span><br><span class="line">        y_predict = [self._predict(x1) <span class="keyword">for</span> x1 <span class="keyword">in</span> X_predict]</span><br><span class="line">        <span class="keyword">return</span> np.array(y_predict)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">distance</span>(<span class="params">self, x</span>):</span><br><span class="line">        d = [np.sqrt(np.<span class="built_in">sum</span>((x_i - x) ** <span class="number">2</span>)) <span class="keyword">for</span> x_i <span class="keyword">in</span> self._x_train]</span><br><span class="line">        d = np.array(d)</span><br><span class="line">        d = np.sort(d)</span><br><span class="line">        d = d[:self.k].mean()</span><br><span class="line">        <span class="keyword">return</span> d</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Distance</span>(<span class="params">self, X_predict</span>):</span><br><span class="line">        res = [self.distance(x1) <span class="keyword">for</span> x1 <span class="keyword">in</span> X_predict]</span><br><span class="line">        <span class="keyword">return</span> np.array(res)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;knn(k=%d):&#x27;</span> % self.k</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">score</span>(<span class="params">self, x_test, y_test</span>):</span><br><span class="line">        y_predict = self.predict(x_test)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sum</span>(y_predict == y_test) / <span class="built_in">len</span>(x_test)</span><br></pre></td></tr></table></figure></div><h2 id="main-py"><a href="#main-py" class="headerlink" title="main.py"></a>main.py</h2><div class="story post-story"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> accuracy_score</span><br><span class="line"><span class="keyword">from</span> KNN <span class="keyword">import</span> KNN</span><br><span class="line"><span class="keyword">from</span> Dataloder <span class="keyword">import</span> DataLoder</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">visualize</span>(<span class="params">X</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(X[<span class="number">2</span>])):</span><br><span class="line">        <span class="keyword">if</span> X[<span class="number">2</span>][i] == <span class="number">0</span>:</span><br><span class="line">            s1 = plt.scatter(X[<span class="number">0</span>][i], X[<span class="number">1</span>][i], s=<span class="number">2</span>, color=<span class="string">&#x27;b&#x27;</span>, marker=<span class="string">&#x27;o&#x27;</span>)</span><br><span class="line">        <span class="keyword">elif</span> X[<span class="number">2</span>][i] == <span class="number">1</span>:</span><br><span class="line">            s2 = plt.scatter(X[<span class="number">0</span>][i], X[<span class="number">1</span>][i], s=<span class="number">2</span>, color=<span class="string">&#x27;r&#x27;</span>, marker=<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    plt.xlabel(<span class="string">&#x27;Index&#x27;</span>)</span><br><span class="line">    plt.ylabel(<span class="string">&#x27;Distance&#x27;</span>)</span><br><span class="line">    plt.ylim((<span class="number">0</span>, <span class="number">30</span>))</span><br><span class="line">    plt.title(<span class="string">&quot;Index_Distance&quot;</span>)</span><br><span class="line">    plt.legend((s1, s2), (<span class="string">&#x27;Normal&#x27;</span>, <span class="string">&#x27;Abnormal&#x27;</span>), loc=<span class="string">&#x27;best&#x27;</span>)</span><br><span class="line">    plt.savefig(<span class="string">&#x27;san.png&#x27;</span>, bbox_inches=<span class="string">&#x27;tight&#x27;</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">roc</span>(<span class="params">X</span>):</span><br><span class="line">    normal = <span class="number">0</span></span><br><span class="line">    X_size = X.shape[<span class="number">1</span>]</span><br><span class="line">    <span class="comment"># roc_rate = np.zeros((2, X_size))</span></span><br><span class="line">    roc_rate = np.zeros((<span class="number">2</span>, <span class="number">10000</span>))  <span class="comment"># 点的数量</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(X_size):</span><br><span class="line">        <span class="keyword">if</span> X[<span class="number">2</span>][i] == <span class="number">0</span>:</span><br><span class="line">            normal += <span class="number">1</span></span><br><span class="line">    abnormal = X_size - normal</span><br><span class="line">    <span class="comment"># max_dis = X[1].max()</span></span><br><span class="line">    max_dis = <span class="number">30</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>):  <span class="comment"># 范围也是点的数量，越大时间越长，roc曲线越准确</span></span><br><span class="line">        threshold = max_dis / <span class="number">10000</span> * j</span><br><span class="line">        normal1 = <span class="number">0</span></span><br><span class="line">        abnormal1 = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(X_size):</span><br><span class="line">            <span class="keyword">if</span> X[<span class="number">1</span>][k] &gt; threshold <span class="keyword">and</span> X[<span class="number">2</span>][k] == <span class="number">0</span>:</span><br><span class="line">                normal1 += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> X[<span class="number">1</span>][k] &gt; threshold <span class="keyword">and</span> X[<span class="number">2</span>][k] != <span class="number">0</span>:</span><br><span class="line">                abnormal1 += <span class="number">1</span></span><br><span class="line">        <span class="comment"># ROC曲线：横轴误报率，即阈值以上正常点 / 全体正常的点；纵轴检测率，即阈值以上异常点 / 全体异常点</span></span><br><span class="line">        roc_rate[<span class="number">0</span>][j] = normal1 / normal  <span class="comment"># 阈值以上正常点/全体正常的点</span></span><br><span class="line">        roc_rate[<span class="number">1</span>][j] = abnormal1 / abnormal  <span class="comment"># 阈值以上异常点/全体异常点</span></span><br><span class="line">        <span class="comment"># roc_rate[0][j] = (abnormal-abnormal1) / abnormal  # 阈值以下异常点/全体异常的点</span></span><br><span class="line">        <span class="comment"># roc_rate[1][j] = (normal-normal1) / normal  # 阈值以下正常点/全体正常点</span></span><br><span class="line">    plt.figure()</span><br><span class="line">    plt.scatter(roc_rate[<span class="number">0</span>], roc_rate[<span class="number">1</span>], edgecolors=<span class="string">&#x27;None&#x27;</span>, s=<span class="number">1</span>, alpha=<span class="number">1</span>)</span><br><span class="line">    plt.savefig(<span class="string">&#x27;Roc0.png&#x27;</span>, bbox_inches=<span class="string">&#x27;tight&#x27;</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    train_x, test_x, train_y, test_y, acc_time = DataLoder()</span><br><span class="line"></span><br><span class="line">    model = KNN(k=<span class="number">1</span>)</span><br><span class="line">    start = time.time()</span><br><span class="line">    model.fit(train_x, train_y)</span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;训练时间：&#x27;</span>, end - start, <span class="string">&#x27;s&#x27;</span>)</span><br><span class="line">    acc_time += end - start</span><br><span class="line"></span><br><span class="line">    start = time.time()</span><br><span class="line">    <span class="comment"># 可以注释掉这一行，因为训练集只有一个类别</span></span><br><span class="line">    <span class="comment"># predict = model.predict(test_x)</span></span><br><span class="line">    distance = model.Distance(test_x)</span><br><span class="line">    result = np.zeros((<span class="built_in">len</span>(test_x), <span class="number">3</span>))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(test_x)):</span><br><span class="line">        <span class="comment"># 序号 最小欧氏距离 测试集数据类别</span></span><br><span class="line">        result[i] = i + <span class="number">1</span>, distance[i], test_y[i]</span><br><span class="line">    <span class="comment"># 矩阵转置</span></span><br><span class="line">    result = np.transpose(result)</span><br><span class="line">    visualize(result)</span><br><span class="line">    roc(result)</span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;预测时间：&#x27;</span>, end - start, <span class="string">&#x27;s&#x27;</span>)</span><br><span class="line">    acc_time += end - start</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;总时间：&#x27;</span>, acc_time, <span class="string">&#x27;s&#x27;</span>)</span><br></pre></td></tr></table></figure></div><h2 id="运行结果可视化："><a href="#运行结果可视化：" class="headerlink" title="运行结果可视化："></a>运行结果可视化：</h2><div class="story post-story"><h3 id="散点图："><a href="#散点图：" class="headerlink" title="散点图："></a>散点图：</h3><p><img src="/../image/KNN(%E8%87%AA%E5%B7%B1%E5%86%99)-Based-Anomaly-Detection/san-16507018622292.png" class="lazyload" data-srcset="/../image/KNN(%E8%87%AA%E5%B7%B1%E5%86%99)-Based-Anomaly-Detection/san-16507018622292.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="san"></p><h3 id="ROC："><a href="#ROC：" class="headerlink" title="ROC："></a>ROC：</h3><h4 id="10000个点"><a href="#10000个点" class="headerlink" title="10000个点"></a>10000个点</h4><p><img src="/../image/KNN(%E8%87%AA%E5%B7%B1%E5%86%99)-Based-Anomaly-Detection/roc.png" class="lazyload" data-srcset="/../image/KNN(%E8%87%AA%E5%B7%B1%E5%86%99)-Based-Anomaly-Detection/roc.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="roc"></p><h4 id="100000个点"><a href="#100000个点" class="headerlink" title="100000个点"></a>100000个点</h4><p><img src="/../image/KNN(%E8%87%AA%E5%B7%B1%E5%86%99)-Based-Anomaly-Detection/Roc0.png" class="lazyload" data-srcset="/../image/KNN(%E8%87%AA%E5%B7%B1%E5%86%99)-Based-Anomaly-Detection/Roc0.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Roc0"></p><p>可以把画ROC的函数改改，再改改main函数，让多条ROC曲线画在同一张画布，用来比较不同K值下的分类性能。</p><p>改之后main.py如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> accuracy_score</span><br><span class="line"><span class="keyword">from</span> KNN <span class="keyword">import</span> KNN</span><br><span class="line"><span class="keyword">from</span> Dataloder <span class="keyword">import</span> DataLoder</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">visualize</span>(<span class="params">X, K</span>):</span><br><span class="line">    plt.figure(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(X[<span class="number">2</span>])):</span><br><span class="line">        <span class="keyword">if</span> X[<span class="number">2</span>][i] == <span class="number">0</span>:</span><br><span class="line">            s1 = plt.scatter(X[<span class="number">0</span>][i], X[<span class="number">1</span>][i], s=<span class="number">2</span>, color=<span class="string">&#x27;b&#x27;</span>, marker=<span class="string">&#x27;o&#x27;</span>)</span><br><span class="line">        <span class="keyword">elif</span> X[<span class="number">2</span>][i] == <span class="number">1</span>:</span><br><span class="line">            s2 = plt.scatter(X[<span class="number">0</span>][i], X[<span class="number">1</span>][i], s=<span class="number">2</span>, color=<span class="string">&#x27;r&#x27;</span>, marker=<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">    plt.xlabel(<span class="string">&#x27;Index&#x27;</span>)</span><br><span class="line">    plt.ylabel(<span class="string">&#x27;Distance&#x27;</span>)</span><br><span class="line">    plt.ylim((<span class="number">0</span>, <span class="number">30</span>))</span><br><span class="line">    plt.title(<span class="string">&quot;Index_Distance&quot;</span>)</span><br><span class="line">    plt.legend((s1, s2), (<span class="string">&#x27;Normal&#x27;</span>, <span class="string">&#x27;Abnormal&#x27;</span>), loc=<span class="string">&#x27;best&#x27;</span>)</span><br><span class="line">    img = <span class="string">&#x27;san_K=&#x27;</span> + <span class="built_in">str</span>(K)</span><br><span class="line">    plt.savefig(img, bbox_inches=<span class="string">&#x27;tight&#x27;</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">roc</span>(<span class="params">X, K</span>):</span><br><span class="line">    normal = <span class="number">0</span></span><br><span class="line">    X_size = X.shape[<span class="number">1</span>]</span><br><span class="line">    <span class="comment"># roc_rate = np.zeros((2, X_size))</span></span><br><span class="line">    roc_rate = np.zeros((<span class="number">2</span>, <span class="number">10000</span>))  <span class="comment"># 点的数量</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(X_size):</span><br><span class="line">        <span class="keyword">if</span> X[<span class="number">2</span>][i] == <span class="number">0</span>:</span><br><span class="line">            normal += <span class="number">1</span></span><br><span class="line">    abnormal = X_size - normal</span><br><span class="line">    <span class="comment"># max_dis = X[1].max()</span></span><br><span class="line">    max_dis = <span class="number">30</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>):  <span class="comment"># 范围也是点的数量，越大时间越长，roc曲线越准确</span></span><br><span class="line">        threshold = max_dis / <span class="number">10000</span> * j</span><br><span class="line">        normal1 = <span class="number">0</span></span><br><span class="line">        abnormal1 = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(X_size):</span><br><span class="line">            <span class="keyword">if</span> X[<span class="number">1</span>][k] &gt; threshold <span class="keyword">and</span> X[<span class="number">2</span>][k] == <span class="number">0</span>:</span><br><span class="line">                normal1 += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> X[<span class="number">1</span>][k] &gt; threshold <span class="keyword">and</span> X[<span class="number">2</span>][k] != <span class="number">0</span>:</span><br><span class="line">                abnormal1 += <span class="number">1</span></span><br><span class="line">        <span class="comment"># ROC曲线：横轴误报率，即阈值以上正常点 / 全体正常的点；纵轴检测率，即阈值以上异常点 / 全体异常点</span></span><br><span class="line">        roc_rate[<span class="number">0</span>][j] = normal1 / normal  <span class="comment"># 阈值以上正常点/全体正常的点</span></span><br><span class="line">        roc_rate[<span class="number">1</span>][j] = abnormal1 / abnormal  <span class="comment"># 阈值以上异常点/全体异常点</span></span><br><span class="line">        <span class="comment"># roc_rate[0][j] = (abnormal-abnormal1) / abnormal  # 阈值以下异常点/全体异常的点</span></span><br><span class="line">        <span class="comment"># roc_rate[1][j] = (normal-normal1) / normal  # 阈值以下正常点/全体正常点</span></span><br><span class="line">    plt.plot(roc_rate[<span class="number">0</span>], roc_rate[<span class="number">1</span>], label=<span class="built_in">str</span>(K))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Res</span>(<span class="params">model, test_x</span>):</span><br><span class="line">    distance = model.Distance(test_x)</span><br><span class="line">    result = np.zeros((<span class="built_in">len</span>(test_x), <span class="number">3</span>))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(test_x)):</span><br><span class="line">        <span class="comment"># 序号 最小欧氏距离 测试集数据类别</span></span><br><span class="line">        result[i] = i + <span class="number">1</span>, distance[i], test_y[i]</span><br><span class="line">    <span class="comment"># 矩阵转置</span></span><br><span class="line">    result = np.transpose(result)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    train_x, test_x, train_y, test_y, acc_time = DataLoder()</span><br><span class="line">    start = time.time()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 散点图和ROC曲线不能同时画，因为散点图是每个K画一个，ROC是多个K画一张图,我用plt.figure()指定了半天没整明白</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">3</span>):</span><br><span class="line">        model = KNN(k=i)</span><br><span class="line">        model.fit(train_x, train_y)</span><br><span class="line">        result = Res(model, test_x)</span><br><span class="line">        <span class="comment"># 散点图和ROC曲线不能同时画</span></span><br><span class="line">        <span class="comment"># visualize(result, i)</span></span><br><span class="line">        roc(result, i)</span><br><span class="line"></span><br><span class="line">    plt.legend()</span><br><span class="line">    plt.savefig(<span class="string">&#x27;Roc.png&#x27;</span>, bbox_inches=<span class="string">&#x27;tight&#x27;</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;总时间：&#x27;</span>, acc_time, <span class="string">&#x27;s&#x27;</span>)</span><br></pre></td></tr></table></figure><p>要多画几条，就改循环中i的范围</p><p><img src="/../image/KNN(%E8%87%AA%E5%B7%B1%E5%86%99)-Based-Anomaly-Detection/roc-16507036004873.png" class="lazyload" data-srcset="/../image/KNN(%E8%87%AA%E5%B7%B1%E5%86%99)-Based-Anomaly-Detection/roc-16507036004873.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="roc"></p></div>]]></content>
      
      
      <categories>
          
          <category> 入侵检测 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Anomaly Detection </tag>
            
            <tag> 机器学习 </tag>
            
            <tag> KNN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>KNN_Sklearn-Based Anomaly Detection</title>
      <link href="/2022/04/21/KNN_Sklearn-Based%20Anomaly%20Detection/"/>
      <url>/2022/04/21/KNN_Sklearn-Based%20Anomaly%20Detection/</url>
      
        <content type="html"><![CDATA[<h1 id="KNN-Sklearn-Based-Anomaly-Detection"><a href="#KNN-Sklearn-Based-Anomaly-Detection" class="headerlink" title="KNN_Sklearn-Based Anomaly Detection"></a>KNN_Sklearn-Based Anomaly Detection</h1><p>这里调用Sklearn中的KNN，实现对ICI-IDS2017数据集的异常检测。</p><p>数据处理为二分类任务。</p><p>如果想做多分类也可以，在数据处理Dataloder.py注释掉:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 变成二分类问题，0正常，1异常</span></span><br><span class="line"><span class="comment"># labels[labels != 0] = 1</span></span><br></pre></td></tr></table></figure><p>在main注释掉:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># roc_sklearn(test_y, probility[:, 1])</span></span><br></pre></td></tr></table></figure><p>画散点图函数def visualize(X)中把添加颜色的循环注释掉，改为按照标签数值设置点颜色：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># for d in range(len(X[2])):</span></span><br><span class="line"><span class="comment">#     colors.append(color[int(X[2][d])])</span></span><br><span class="line">plt.figure()</span><br><span class="line">plt.scatter(X[<span class="number">0</span>], X[<span class="number">1</span>], c=X[<span class="number">2</span>], edgecolors=<span class="string">&#x27;None&#x27;</span>, s=<span class="number">2</span>, alpha=<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>主要思路是：</p><ul><li><p>调用Sklearn中KNN实现二分类（异常&#x2F;正常），训练集测试集都有俩个类别</p></li><li><p>画出测试集结果的散点图</p><ul><li><p>散点图的横坐标是index（序号，第几个）</p></li><li><p>散点图纵坐标是离它最近的K个点距离的平均值</p></li></ul></li><li><p>画出ROC曲线，调用sklearn中roc_curve()函数直接返回，tpr，fpr，阈值</p><ul><li>ROC曲线的横纵坐标就是FPR和TPR，然后调用plt.plot()</li></ul></li></ul><p>因为老师上课要求必须得有散点图和ROC曲线，所以就这么搞了。听老师指正以及和同学讨论之后，觉得自己可能有点小偏差。</p><p>可能老师讲的做异常检测的KNN的正常的做法是：（下一篇更新）</p><ul><li>数据集划分，训练集全部用正常样本，测试集异常正常都有</li><li>散点图中的横坐标还是index，纵坐标是测试样本和正常样本的最小k个距离的平均</li><li>这样，就可以通过，不断的取阈值来画出ROC曲线。每取一个阈值，阈值以上都判定为异常点，阈值以下判断为正常点，计算FPR和TPR</li><li>这样做不能通过调用函数来计算准确率，因为训练集只有一个类别</li></ul><h2 id="Project文件结构"><a href="#Project文件结构" class="headerlink" title="Project文件结构"></a>Project文件结构</h2><div class="story post-story"><p><img src="/../image/KNN_Sklearn-Based%20Anomaly%20Detection/image-20220421102535742.png" class="lazyload" data-srcset="/../image/KNN_Sklearn-Based%20Anomaly%20Detection/image-20220421102535742.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220421102535742"></p></div><h2 id="Dataloder-py"><a href="#Dataloder-py" class="headerlink" title="Dataloder.py"></a>Dataloder.py</h2><div class="story post-story"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> preprocessing</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据file读取数据</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">readData</span>(<span class="params">file</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Loading raw data...&quot;</span>)</span><br><span class="line">    raw_data = pd.read_csv(file, header=<span class="literal">None</span>, low_memory=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">return</span> raw_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回需要清除的行数list</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">clearDirtyData</span>(<span class="params">df</span>):</span><br><span class="line">    dropList = df[(df[<span class="number">14</span>] == <span class="string">&quot;Nan&quot;</span>) | (df[<span class="number">15</span>] == <span class="string">&quot;Infinity&quot;</span>)].index.tolist()</span><br><span class="line">    <span class="keyword">return</span> dropList</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lookData</span>(<span class="params">raw_data</span>):</span><br><span class="line">    <span class="comment"># 打印数据集的标签数据数量</span></span><br><span class="line">    <span class="comment"># last_column_index = raw_data.shape[1] - 1</span></span><br><span class="line">    <span class="comment"># print(raw_data[last_column_index].value_counts())</span></span><br><span class="line">    <span class="comment"># 取出数据集标签部分</span></span><br><span class="line">    labels = raw_data.iloc[:, raw_data.shape[<span class="number">1</span>] - <span class="number">1</span>:]</span><br><span class="line">    <span class="comment"># 多维数组转为以为数组</span></span><br><span class="line">    labels = labels.values.ravel()</span><br><span class="line">    label_set = <span class="built_in">set</span>(labels)</span><br><span class="line">    <span class="keyword">return</span> label_set</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">separateData</span>(<span class="params">raw_data</span>):</span><br><span class="line">    lists = raw_data.values.tolist()</span><br><span class="line">    temp_lists = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">2</span>):</span><br><span class="line">        temp_lists.append([])</span><br><span class="line">    <span class="comment"># 得到raw_data的数据标签集合</span></span><br><span class="line">    label_set = lookData(raw_data)</span><br><span class="line">    <span class="comment"># 将无序的数据标签集合转换为有序的list</span></span><br><span class="line">    label_list = <span class="built_in">list</span>(label_set)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(lists)):</span><br><span class="line">        <span class="comment"># 得到所属标签的索引号</span></span><br><span class="line">        data_index = label_list.index(lists[i][<span class="built_in">len</span>(lists[<span class="number">0</span>]) - <span class="number">1</span>])</span><br><span class="line">        temp_lists[data_index].append(lists[i])</span><br><span class="line">    <span class="keyword">return</span> temp_lists</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DataLoder</span>():</span><br><span class="line">    acc_time = <span class="number">0</span></span><br><span class="line">    <span class="comment"># ----------------------------------------读取数据，合并到一个DataFrame---------------------------------------</span></span><br><span class="line">    start = time.time()</span><br><span class="line">    data_1 = readData(<span class="string">&quot;data\MachineLearningCVE\Monday-WorkingHours.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_1 = data_1.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_2 = readData(<span class="string">&quot;data\MachineLearningCVE\Tuesday-WorkingHours.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_2 = data_2.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_3 = readData(<span class="string">&quot;data\MachineLearningCVE\Wednesday-workingHours.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_3 = data_3.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_4 = readData(<span class="string">&quot;data\MachineLearningCVE\Thursday-WorkingHours-Afternoon-Infilteration.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_4 = data_4.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_5 = readData(<span class="string">&quot;data\MachineLearningCVE\Thursday-WorkingHours-Morning-WebAttacks.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_5 = data_5.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_6 = readData(<span class="string">&quot;data\MachineLearningCVE\Friday-WorkingHours-Morning.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_6 = data_6.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_7 = readData(<span class="string">&quot;data\MachineLearningCVE\Friday-WorkingHours-Afternoon-DDos.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_7 = data_7.drop([<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    data_8 = readData(<span class="string">&quot;data\MachineLearningCVE\Friday-WorkingHours-Afternoon-PortScan.pcap_ISCX.csv&quot;</span>)</span><br><span class="line">    data_8 = data_8.drop([<span class="number">0</span>])</span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;数据加载时间：&#x27;</span>, end - start, <span class="string">&#x27;s&#x27;</span>)</span><br><span class="line">    acc_time += end - start</span><br><span class="line">    <span class="comment"># ----------------------------------------处理数据---------------------------------------</span></span><br><span class="line">    <span class="comment"># print(&#x27;开始处理数据&#x27;)</span></span><br><span class="line">    start = time.time()</span><br><span class="line">    temp = [data_1, data_2, data_3, data_4, data_5, data_6, data_7, data_8]</span><br><span class="line">    <span class="comment"># temp = [data_7, data_8]</span></span><br><span class="line">    data_all = pd.concat(temp)</span><br><span class="line">    <span class="comment"># 删除Nan和Infinity所在行</span></span><br><span class="line">    data_list_clear = clearDirtyData(data_all)</span><br><span class="line">    data_all = data_all.drop(data_list_clear)</span><br><span class="line">    <span class="built_in">print</span>(data_all[data_all.shape[<span class="number">1</span>] - <span class="number">1</span>].value_counts())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 数据量太大，可以降采样frac=抽取百分比</span></span><br><span class="line">    data_all = data_all.sample(frac=<span class="number">0.01</span>)</span><br><span class="line">    <span class="built_in">print</span>(data_all[data_all.shape[<span class="number">1</span>] - <span class="number">1</span>].value_counts())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 把最后一列lable转化为数值</span></span><br><span class="line">    data_all[data_all.shape[<span class="number">1</span>] - <span class="number">1</span>], attacks = pd.factorize(data_all[data_all.shape[<span class="number">1</span>] - <span class="number">1</span>], sort=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># data_all[78][data_all[78] != 0] = 1</span></span><br><span class="line">    <span class="comment"># print(data_all[data_all.shape[1] - 1].value_counts())</span></span><br><span class="line">    <span class="comment"># ----------------------------------------降采样正常样本---------------------------------------</span></span><br><span class="line">    <span class="comment"># data_all[78][data_all[78] != 0] = 1</span></span><br><span class="line">    <span class="comment"># lists = separateData(data_all)</span></span><br><span class="line">    <span class="comment"># normal = pd.DataFrame(lists[0])</span></span><br><span class="line">    <span class="comment"># normal = normal.sample(frac=0.5)</span></span><br><span class="line">    <span class="comment"># abnormal = pd.DataFrame(lists[1])</span></span><br><span class="line">    <span class="comment"># temp = [normal, abnormal]</span></span><br><span class="line">    <span class="comment"># data_all = pd.concat(temp)</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># print(data_all[data_all.shape[1] - 1].value_counts())</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ----------------------------------------数据处理，标准化、归一化、等---------------------------------------</span></span><br><span class="line">    features = data_all.iloc[:, :data_all.shape[<span class="number">1</span>] - <span class="number">1</span>].values</span><br><span class="line">    labels = data_all.iloc[:, data_all.shape[<span class="number">1</span>] - <span class="number">1</span>:].values</span><br><span class="line">    <span class="comment"># 标准化.高斯分布(0,1)</span></span><br><span class="line">    features = preprocessing.scale(features)</span><br><span class="line">    <span class="comment"># 最小最大值标准化,最小0，最大1，可以指定范围</span></span><br><span class="line">    <span class="comment"># features = preprocessing.minmax_scale(features)</span></span><br><span class="line">    <span class="comment"># 归一化</span></span><br><span class="line">    <span class="comment"># features = preprocessing.normalize(features, norm=&quot;l2&quot;)</span></span><br><span class="line">    <span class="comment"># features = pd.DataFrame(features)</span></span><br><span class="line">    labels = labels.ravel()</span><br><span class="line">    <span class="comment"># 变成二分类问题，0正常，1异常</span></span><br><span class="line">    labels[labels != <span class="number">0</span>] = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    train_x, test_x, train_y, test_y = train_test_split(features, labels, test_size=<span class="number">0.3</span>)</span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;数据处理时间：&#x27;</span>, end - start, <span class="string">&#x27;s&#x27;</span>)</span><br><span class="line">    acc_time += end - start</span><br><span class="line">    <span class="keyword">return</span> train_x, test_x, train_y, test_y, acc_time</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><h2 id="main-py"><a href="#main-py" class="headerlink" title="main.py"></a>main.py</h2><div class="story post-story"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scipy.io <span class="keyword">as</span> sio</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> accuracy_score</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> roc_curve, auc</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> metrics</span><br><span class="line"><span class="keyword">from</span> sklearn.decomposition <span class="keyword">import</span> PCA</span><br><span class="line"><span class="keyword">from</span> Dataloder <span class="keyword">import</span> DataLoder</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> GridSearchCV</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> cross_val_score</span><br><span class="line"><span class="keyword">from</span> sklearn.neighbors <span class="keyword">import</span> KNeighborsClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> datasets</span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> confusion_matrix</span><br><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> AdaBoostClassifier</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">visualize</span>(<span class="params">X</span>):</span><br><span class="line">    <span class="comment"># dd = []</span></span><br><span class="line">    <span class="comment"># for d in range(len(X[0])):</span></span><br><span class="line">    <span class="comment">#     if X[1][d] &gt; 10:</span></span><br><span class="line">    <span class="comment">#         dd.append(d)</span></span><br><span class="line">    <span class="comment">#         # X = np.delete(X, d, axis=1)</span></span><br><span class="line">    <span class="comment">#         # X[1][d] = avg</span></span><br><span class="line">    <span class="comment"># X = np.delete(X, dd, axis=1)</span></span><br><span class="line">    color = [<span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;r&#x27;</span>]  <span class="comment"># 设置颜色</span></span><br><span class="line">    colors = []</span><br><span class="line">    marker = [<span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;x&#x27;</span>]  <span class="comment"># 设置点的形状</span></span><br><span class="line">    makers = []</span><br><span class="line">    <span class="keyword">for</span> d <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(X[<span class="number">2</span>])):</span><br><span class="line">        colors.append(color[<span class="built_in">int</span>(X[<span class="number">2</span>][d])])</span><br><span class="line">    plt.figure()</span><br><span class="line">    plt.scatter(X[<span class="number">0</span>], X[<span class="number">1</span>], c=colors, edgecolors=<span class="string">&#x27;None&#x27;</span>, s=<span class="number">2</span>, alpha=<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># plt.ylim((0, 0.5))</span></span><br><span class="line">    plt.savefig(<span class="string">&#x27;result.png&#x27;</span>, bbox_inches=<span class="string">&#x27;tight&#x27;</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">roc_sklearn</span>(<span class="params">true, pro</span>):</span><br><span class="line">    <span class="comment"># fpr, tpr, thresholds = roc_curve(true, pro, pos_label=1, drop_intermediate=False)</span></span><br><span class="line">    fpr, tpr, thresholds = roc_curve(true, pro, pos_label=<span class="number">1</span>, drop_intermediate=<span class="literal">True</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;FPR , TPR , thresholds&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i, value <span class="keyword">in</span> <span class="built_in">enumerate</span>(thresholds):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;%f %f %f&quot;</span> % (fpr[i], tpr[i], value))</span><br><span class="line">    roc_auc = auc(fpr, tpr)</span><br><span class="line">    plt.plot(fpr, tpr, label=<span class="string">&#x27;ROC (area = &#123;0:.4f&#125;)&#x27;</span>.<span class="built_in">format</span>(roc_auc), lw=<span class="number">1</span>, linestyle=<span class="string">&quot;-&quot;</span>, color=<span class="string">&#x27;red&#x27;</span>)</span><br><span class="line">    plt.plot([<span class="number">0</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">1</span>], <span class="string">&#x27;--&#x27;</span>, color=(<span class="number">0.6</span>, <span class="number">0.6</span>, <span class="number">0.6</span>), label=<span class="string">&#x27;Luck&#x27;</span>)  <span class="comment"># 画对角线</span></span><br><span class="line">    plt.xlim([-<span class="number">0.02</span>, <span class="number">1.05</span>])</span><br><span class="line">    plt.ylim([-<span class="number">0.02</span>, <span class="number">1.05</span>])</span><br><span class="line">    plt.xlabel(<span class="string">&#x27;False Positive Rate&#x27;</span>)</span><br><span class="line">    plt.ylabel(<span class="string">&#x27;True Positive Rate&#x27;</span>)</span><br><span class="line">    plt.title(<span class="string">&#x27;ROC Curve&#x27;</span>)</span><br><span class="line">    plt.legend(loc=<span class="string">&quot;lower right&quot;</span>)</span><br><span class="line">    plt.savefig(<span class="string">&#x27;roc.png&#x27;</span>, bbox_inches=<span class="string">&#x27;tight&#x27;</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">roc</span>(<span class="params">data_set</span>):</span><br><span class="line">    normal = <span class="number">0</span></span><br><span class="line">    data_set_size = data_set.shape[<span class="number">1</span>]</span><br><span class="line">    <span class="comment"># roc_rate = np.zeros((2, data_set_size))</span></span><br><span class="line">    roc_rate = np.zeros((<span class="number">2</span>, <span class="number">100000</span>))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(data_set_size):</span><br><span class="line">        <span class="keyword">if</span> data_set[<span class="number">2</span>][i] == <span class="number">0</span>:</span><br><span class="line">            normal += <span class="number">1</span></span><br><span class="line">    abnormal = data_set_size - normal</span><br><span class="line">    <span class="comment"># max_dis = data_set[1].max()/10</span></span><br><span class="line">    max_dis = <span class="number">10</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100000</span>):</span><br><span class="line">        threshold = max_dis / <span class="number">100000</span> * j</span><br><span class="line">        normal1 = <span class="number">0</span></span><br><span class="line">        abnormal1 = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(data_set_size):</span><br><span class="line">            <span class="keyword">if</span> data_set[<span class="number">1</span>][k] &gt; threshold <span class="keyword">and</span> data_set[<span class="number">2</span>][k] == <span class="number">0</span>:</span><br><span class="line">                normal1 += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> data_set[<span class="number">1</span>][k] &gt; threshold <span class="keyword">and</span> data_set[<span class="number">2</span>][k] != <span class="number">0</span>:</span><br><span class="line">                abnormal1 += <span class="number">1</span></span><br><span class="line">        <span class="comment"># ROC曲线：横轴误报率，即阈值以上正常点 / 全体正常的点；纵轴检测率，即阈值以上异常点 / 全体异常点</span></span><br><span class="line">        roc_rate[<span class="number">0</span>][j] = normal1 / normal  <span class="comment"># 阈值以上正常点/全体正常的点</span></span><br><span class="line">        roc_rate[<span class="number">1</span>][j] = abnormal1 / abnormal  <span class="comment"># 阈值以上异常点/全体异常点</span></span><br><span class="line">        <span class="comment"># roc_rate[0][j] = (abnormal-abnormal1) / abnormal  # 阈值以下异常点/全体异常的点</span></span><br><span class="line">        <span class="comment"># roc_rate[1][j] = (normal-normal1) / normal  # 阈值以下正常点/全体正常点</span></span><br><span class="line">    <span class="keyword">return</span> roc_rate</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Confusion_matrix_hp</span>(<span class="params">cm</span>):</span><br><span class="line">    cm = pd.DataFrame(cm)</span><br><span class="line">    sns.heatmap(cm, annot=<span class="literal">True</span>, cmap=<span class="string">&#x27;GnBu&#x27;</span>)</span><br><span class="line">    plt.xlabel(<span class="string">&#x27;Real Label&#x27;</span>)</span><br><span class="line">    plt.ylabel(<span class="string">&#x27;Predict Label&#x27;</span>)</span><br><span class="line">    plt.savefig(<span class="string">&#x27;Confusion.png&#x27;</span>, bbox_inches=<span class="string">&#x27;tight&#x27;</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Confuse</span>(<span class="params">y_true, y_pred</span>):</span><br><span class="line">    maxtrix = confusion_matrix(y_true, y_pred)</span><br><span class="line">    plt.matshow(maxtrix)</span><br><span class="line">    plt.colorbar()</span><br><span class="line">    plt.xticks(np.arange(maxtrix.shape[<span class="number">1</span>]))</span><br><span class="line">    plt.yticks(np.arange(maxtrix.shape[<span class="number">1</span>]))</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    train_x, test_x, train_y, test_y, acc_time = DataLoder()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># x = train_x  # 特征</span></span><br><span class="line">    <span class="comment"># y = train_y  # 标签</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># r_range = range(1, 30)  # n_neighbors的取值范围</span></span><br><span class="line">    <span class="comment"># r_list = list()</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># start = time.time()</span></span><br><span class="line">    <span class="comment"># for r in r_range:</span></span><br><span class="line">    <span class="comment">#     knn = KNeighborsClassifier(n_neighbors=r)</span></span><br><span class="line">    <span class="comment">#     scores = cross_val_score(knn, x, y, cv=5, scoring=&quot;accuracy&quot;)</span></span><br><span class="line">    <span class="comment">#     r_list.append(scores.mean())  # 5折交叉验证的平均值</span></span><br><span class="line">    <span class="comment"># end = time.time()</span></span><br><span class="line">    <span class="comment"># print(&#x27;选择最佳K值时间：&#x27;, end - start, &#x27;s&#x27;)</span></span><br><span class="line">    <span class="comment"># acc_time += end - start</span></span><br><span class="line">    <span class="comment"># plt.plot(r_range, r_list)</span></span><br><span class="line">    <span class="comment"># plt.savefig(&#x27;K.png&#x27;, bbox_inches=&#x27;tight&#x27;)</span></span><br><span class="line">    <span class="comment"># plt.show()</span></span><br><span class="line">    <span class="comment"># print(&#x27;最佳K值:&#x27;, (r_list.index(max(r_list))) + 1)</span></span><br><span class="line">    <span class="comment"># best_K = (r_list.index(max(r_list))) + 1</span></span><br><span class="line">    <span class="comment"># model = LogisticRegression()</span></span><br><span class="line">    <span class="comment"># model = RandomForestClassifier()</span></span><br><span class="line">    <span class="comment"># model = XGBClassifier()</span></span><br><span class="line">    <span class="comment"># model = KNeighborsClassifier(n_neighbors=best_K)</span></span><br><span class="line"></span><br><span class="line">    model = KNeighborsClassifier(n_neighbors=<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># model = AdaBoostClassifier(n_estimators=5)</span></span><br><span class="line">    start = time.time()</span><br><span class="line">    model.fit(train_x, train_y)</span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;训练时间：&#x27;</span>, end - start, <span class="string">&#x27;s&#x27;</span>)</span><br><span class="line">    acc_time += end - start</span><br><span class="line"></span><br><span class="line">    start = time.time()</span><br><span class="line">    predict = model.predict(test_x)</span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;预测时间：&#x27;</span>, end - start, <span class="string">&#x27;s&#x27;</span>)</span><br><span class="line">    acc_time += end - start</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;总时间：&#x27;</span>, acc_time, <span class="string">&#x27;s&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    probility = model.predict_proba(test_x)</span><br><span class="line">    <span class="comment"># score = model.score(test_x, test_y)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(&#x27;predict=&#x27;, predict)</span></span><br><span class="line">    <span class="comment"># print(&#x27;Accuracy:&#x27;, score)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Accuracy:&#x27;</span>, accuracy_score(test_y, predict))</span><br><span class="line">    <span class="built_in">print</span>(metrics.classification_report(test_y, predict))</span><br><span class="line"></span><br><span class="line">    distances, indices = model.kneighbors(X=test_x)</span><br><span class="line">    test_size = <span class="built_in">len</span>(test_x)</span><br><span class="line">    result = np.zeros((test_size, <span class="number">3</span>))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(test_size):</span><br><span class="line">        <span class="comment"># 序号 最小欧氏距离 测试集数据类别</span></span><br><span class="line">        result[i] = i + <span class="number">1</span>, distances[i].mean(), test_y[i]</span><br><span class="line">    <span class="comment"># 矩阵转置</span></span><br><span class="line">    result = np.transpose(result)</span><br><span class="line">    visualize(result)</span><br><span class="line"></span><br><span class="line">    roc_sklearn(test_y, probility[:, <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># roc_rate = roc(result)</span></span><br><span class="line">    <span class="comment"># plt.figure()</span></span><br><span class="line">    <span class="comment"># plt.scatter(roc_rate[0], roc_rate[1], edgecolors=&#x27;None&#x27;, s=1, alpha=1)</span></span><br><span class="line">    <span class="comment"># plt.show()</span></span><br><span class="line"></span><br><span class="line">    cm = confusion_matrix(test_y, predict)</span><br><span class="line">    <span class="comment"># cm = pd.crosstab(predict, test_y)</span></span><br><span class="line">    Confusion_matrix_hp(cm)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># list_diag = np.diag(cm)</span></span><br><span class="line">    <span class="comment"># list_raw_sum = np.sum(cm, axis=1)</span></span><br><span class="line">    <span class="comment"># print(&quot;Predict accuracy of the decisionTree: &quot;, np.mean(list_diag) / np.mean(list_raw_sum))</span></span><br><span class="line">    <span class="comment"># Confuse(test_y,predict)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ----------------------------------------降维可视化---------------------------------------</span></span><br><span class="line">    <span class="comment"># pca = PCA(n_components=2)</span></span><br><span class="line">    <span class="comment"># newData = pca.fit_transform(test_x)</span></span><br><span class="line">    <span class="comment"># plt.figure()</span></span><br><span class="line">    <span class="comment"># plt.scatter(newData[:, 0], newData[:, 1], c=test_y, s=50)</span></span><br><span class="line">    <span class="comment"># plt.show()</span></span><br></pre></td></tr></table></figure></div><h2 id="运行结果可视化："><a href="#运行结果可视化：" class="headerlink" title="运行结果可视化："></a>运行结果可视化：</h2><div class="story post-story"><h3 id="k折交叉验证选取K值：代码里注释掉了，每选一次等于预测运行k次，非常耗时"><a href="#k折交叉验证选取K值：代码里注释掉了，每选一次等于预测运行k次，非常耗时" class="headerlink" title="k折交叉验证选取K值：代码里注释掉了，每选一次等于预测运行k次，非常耗时"></a>k折交叉验证选取K值：代码里注释掉了，每选一次等于预测运行k次，非常耗时</h3><p><img src="/../image/KNN_Sklearn-Based%20Anomaly%20Detection/K.png" class="lazyload" data-srcset="/../image/KNN_Sklearn-Based%20Anomaly%20Detection/K.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="K"></p><h3 id="散点图：（可以在代码里限制一下y轴范围）"><a href="#散点图：（可以在代码里限制一下y轴范围）" class="headerlink" title="散点图：（可以在代码里限制一下y轴范围）"></a>散点图：（可以在代码里限制一下y轴范围）</h3><p><img src="/../image/KNN_Sklearn-Based%20Anomaly%20Detection/result-16505047291582.png" class="lazyload" data-srcset="/../image/KNN_Sklearn-Based%20Anomaly%20Detection/result-16505047291582.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="result"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">visualize</span>(<span class="params">X</span>):</span><br><span class="line">    color = [<span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;r&#x27;</span>]  <span class="comment"># 设置颜色</span></span><br><span class="line">    colors = []</span><br><span class="line">    <span class="keyword">for</span> d <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(X[<span class="number">2</span>])):</span><br><span class="line">        colors.append(color[<span class="built_in">int</span>(X[<span class="number">2</span>][d])])</span><br><span class="line">    plt.figure()</span><br><span class="line">    plt.scatter(X[<span class="number">0</span>], X[<span class="number">1</span>], c=X[<span class="number">2</span>], edgecolors=<span class="string">&#x27;None&#x27;</span>, s=<span class="number">2</span>, alpha=<span class="number">1</span>)</span><br><span class="line">    plt.ylim(<span class="number">0</span>, <span class="number">10</span>) <span class="comment"># 限制y轴 </span></span><br><span class="line">    plt.savefig(<span class="string">&#x27;result.png&#x27;</span>, bbox_inches=<span class="string">&#x27;tight&#x27;</span>)</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure><h3 id="限制后："><a href="#限制后：" class="headerlink" title="限制后："></a>限制后：</h3><p><img src="/../image/KNN_Sklearn-Based%20Anomaly%20Detection/result-16505055759763.png" class="lazyload" data-srcset="/../image/KNN_Sklearn-Based%20Anomaly%20Detection/result-16505055759763.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="result"></p><h3 id="Roc曲线："><a href="#Roc曲线：" class="headerlink" title="Roc曲线："></a>Roc曲线：</h3><p><img src="/../image/KNN_Sklearn-Based%20Anomaly%20Detection/roc.png" class="lazyload" data-srcset="/../image/KNN_Sklearn-Based%20Anomaly%20Detection/roc.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="roc"></p><h3 id="混淆矩阵："><a href="#混淆矩阵：" class="headerlink" title="混淆矩阵："></a>混淆矩阵：</h3><p><img src="/../image/KNN_Sklearn-Based%20Anomaly%20Detection/Confusion.png" class="lazyload" data-srcset="/../image/KNN_Sklearn-Based%20Anomaly%20Detection/Confusion.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Confusion"></p></div>]]></content>
      
      
      <categories>
          
          <category> 入侵检测 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Anomaly Detection </tag>
            
            <tag> 机器学习 </tag>
            
            <tag> KNN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>“火焰”病毒</title>
      <link href="/2022/03/29/%E2%80%9C%E7%81%AB%E7%84%B0%E2%80%9D%E7%97%85%E6%AF%92/"/>
      <url>/2022/03/29/%E2%80%9C%E7%81%AB%E7%84%B0%E2%80%9D%E7%97%85%E6%AF%92/</url>
      
        <content type="html"><![CDATA[<h1 id="“火焰”病毒"><a href="#“火焰”病毒" class="headerlink" title="“火焰”病毒"></a>“火焰”病毒</h1><h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><div class="story post-story"><p><img src="/../image/%E2%80%9C%E7%81%AB%E7%84%B0%E2%80%9D%E7%97%85%E6%AF%92/image-20220329223427511.png" class="lazyload" data-srcset="/../image/%E2%80%9C%E7%81%AB%E7%84%B0%E2%80%9D%E7%97%85%E6%AF%92/image-20220329223427511.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220329223427511"></p><p>2012年5月，卡巴斯基实验室发现了一种功能强大、结构复杂的计算机病毒，该病毒的攻击目标仅为中东和部分非洲国家的计算机系统。由于该病毒的一个主要模块中含有“Flame”字样，所以卡巴斯基实验室将其命名为“火焰”（Flame）病毒。</p><p>火焰病毒是一种集成了渗透扩散、预留后门、信息窃取等功能的间谍软件。通过分析火焰病毒的部分样本，安全专家发现该病毒可能在2008年就已经存在，秘密地潜伏了5年。在这些年中，火焰病毒利用模块化程度高的特性，不断更新程序模块，强化功能。目前获取的火焰病毒样本中包含了多个特定功能的库文件，如SSL&#x2F;SSH加密通信库、压缩库、加密库、网络嗅探库、数据解析库、SQLite3文本型数据库和Lua脚本解释库等，大小有20MB左右，这和之前发现的各种病毒软件有很大的区别。火焰病毒程序极其复杂，代码量达到65万行，是普通间谍病毒软件的100倍，以复杂程度和功能来衡量，Flame被包括世界电信联盟等官方以及卡巴斯基等国际权威厂商认定为迄今为止最复杂、最危险、最致命的病毒的计算机病毒之一。</p><h3 id="火焰病毒的攻击模型："><a href="#火焰病毒的攻击模型：" class="headerlink" title="火焰病毒的攻击模型："></a>火焰病毒的攻击模型：</h3><p>火焰病毒的攻击方法是一套清晰的攻击模型，主要分为四步：</p><ol><li>发起中间人攻击；</li><li>劫持篡改通信内容；</li><li>伪造数字证书；</li><li>假冒签名伪造通信内容。</li></ol></div><h2 id="二、技术分析"><a href="#二、技术分析" class="headerlink" title="二、技术分析"></a>二、技术分析</h2><div class="story post-story"><p>“火焰”是一个模块化的、可扩展和更新的恶意程序，根据自身特性主要从事以下活动：扫描网络资源，窃取信息；通过SSH和HTTPS协议与C&amp;C服务器进行通讯；同时使用内核模式和用户模式逻辑，使用WindowsAPC调用和线程启动操纵将其内部功能复杂化，将代码注入关键的进程中；作为Winlogon.exe的一部分被加载，之后注入到Explorer and Services；创建屏幕截图，记录音频会话；在Windows XP，Windows Vista和Windows7系统上运行；利用打印程序和快捷方式漏洞，使用SQLite存储收集到的信息；使用定制的DB作为攻击模块（表明该恶意代码的模块性和可扩展性）；使用经PE加密的信息资源。</p><h3 id="2-1文件组成"><a href="#2-1文件组成" class="headerlink" title="2.1文件组成"></a>2.1文件组成</h3><p><img src="/../image/%E2%80%9C%E7%81%AB%E7%84%B0%E2%80%9D%E7%97%85%E6%AF%92/image-20220329223435069.png" class="lazyload" data-srcset="/../image/%E2%80%9C%E7%81%AB%E7%84%B0%E2%80%9D%E7%97%85%E6%AF%92/image-20220329223435069.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220329223435069"></p><p>火焰病毒包含或产生的各种类型文件如图1所示。</p><h4 id="（1）病毒模块文件"><a href="#（1）病毒模块文件" class="headerlink" title="（1）病毒模块文件"></a>（1）病毒模块文件</h4><p>火焰病毒的可执行模块包括mssecmgr.ocx、msglu32.ocx、nteps32.ocx、advnetcfg.ocx和soapr32.ocx等。其中，mssecmgr.ocx为主模块程序，由该模块完成病毒的执行，并将其他各模块注入系统进程。火焰病毒的模块文件存放在%windir%\system32目录下；其他通过更新升级下载的模块文件也存放在该目录下。</p><h4 id="（2）病毒配置文件"><a href="#（2）病毒配置文件" class="headerlink" title="（2）病毒配置文件"></a>（2）病毒配置文件</h4><p>火焰病毒的配置数据文件包括ccalc32.sys和boot32drv.sys，其存放位置在%windir%\system32目录下。</p><h4 id="（3）病毒运行时产生的文件"><a href="#（3）病毒运行时产生的文件" class="headerlink" title="（3）病毒运行时产生的文件"></a>（3）病毒运行时产生的文件</h4><p>火焰病毒在运行时将产生记录执行情况的日志文件、包含各类被感染主机信息的信息收集文件、包含窃取用户信息的数据文件和SQLite3数据库文件等，以上文件主要存放在%windir%\temp、%windir%和%windir%\system32等目录下。</p><p>火焰病毒具有极强的防护能力，其模块文件、配置文件、日志文件和数据文件等都采用压缩算法进行压缩，并且经过加密算法和密钥进行加密，使用常用的安全软件无法检测出病毒的程序文件。</p><h3 id="2-2传播途径-amp-启动过程"><a href="#2-2传播途径-amp-启动过程" class="headerlink" title="2.2传播途径&amp;启动过程"></a>2.2传播途径&amp;启动过程</h3><h4 id="传播途径"><a href="#传播途径" class="headerlink" title="传播途径"></a>传播途径</h4><p>“火焰”病毒的传播途径主要包括：网络共享捕获管理员信息；Windows打印后台服务远程代码执行漏洞（CVE-2010-2729）；通过移动存储设备进行感染传播；通过Windows的快捷方式’LNK&#x2F;PIF’的自动文件执行漏洞（CVE-2010-2568）进行传播。</p><h4 id="启动过程"><a href="#启动过程" class="headerlink" title="启动过程"></a>启动过程</h4><p>该病毒可以采用以下两种不同的方法启动：</p><p>1）在注册表中添加自启动方式</p><p>HKLM_SYSTEM\CurrentControlSet\Control\LsaAuthenticationPackages&#x3D;mssecmgr.ocx</p><p>2）使用如下命令，从rundll32运行：</p><p>start&#x2F;wait rundll32.exec:\windows\system32\mssecmgr.ocx,DDEnumCallback</p><p>火焰病毒的主模块程序是mssecmgr.ocx，系统在启动时加载执行mssecmgr.ocx，mssecmgr.ocx从其资源中提取火焰病毒各程序模块，通过解密、注入等方式将各模块注入winlogon.exe、services.exe、explorer.exe和iexplorer.exe等系统进程，其基本的时序关系如图2所示。</p><p><img src="/../image/%E2%80%9C%E7%81%AB%E7%84%B0%E2%80%9D%E7%97%85%E6%AF%92/image-20220329223445657.png" class="lazyload" data-srcset="/../image/%E2%80%9C%E7%81%AB%E7%84%B0%E2%80%9D%E7%97%85%E6%AF%92/image-20220329223445657.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220329223445657"></p><p>详细过程：在启动时，火焰病毒会多次加载其功能模块，mssecmgr.ocx文件作为LSA身份验证包被加载，大概2分钟后，advnetcfg.ocx文件通过services.exe进程被加载，每2~3分钟重复3次；大约2分钟之后，services.exe从mssecmgr.ocx加载nteps32.ocx，然后winlogon.exe进程也加载nteps32.ocx文件；该文件被多次加载，同时explorer.exe开始创建5个iexplore进程，紧接着创建wpgfilter.dat文件；2分钟后，ccalc32.sys被service.exe写入，随后在1分钟内winlogon.exe对其进行加载，接下来mssecmgr.ocx被复制到wavsup3.drv；然后boot32drv.sys被services.exe加载。</p><h3 id="2-3程序模块注入"><a href="#2-3程序模块注入" class="headerlink" title="2.3程序模块注入"></a>2.3程序模块注入</h3><p>火焰病毒的多个程序模块经压缩和加密后被封装在主模块mssecmgr.ocx或其他模块的资源节中，只有在病毒启动时，才被解密解压缩，并被注入到可信系统进程空间中。在代码注入的过程中，功能模块基本上不以文件的形式写到文件系统中；功能模块注入时不采用CreateRomteThread（）和LoadLibrary（）等易被安全软件监控的函数，而是通过PE文件内存动态加载技术实现程序模块远程注入。</p><h3 id="2-4SQLite3文件型数据库"><a href="#2-4SQLite3文件型数据库" class="headerlink" title="2.4SQLite3文件型数据库"></a>2.4SQLite3文件型数据库</h3><p>SQLite3是一个轻量级的文件型数据库系统，它占用资源非常低，其库模块文件只有几百KB大小，能够支持Windows、Linux、Unix等主流操作系统，同时能够和很多程序语言相结合，比如Tcl、PHP、Java等，还有ODBC接口，其处理效率也很高。在火焰病毒中集成了一个SQLite3库，通过该数据库系统可以对窃取的各类信息进行高效存储管理。</p><h3 id="2-5Lua脚本语言"><a href="#2-5Lua脚本语言" class="headerlink" title="2.5Lua脚本语言"></a>2.5Lua脚本语言</h3><p>Lua是一个小巧的脚本语言，其设计目的是嵌入应用程序，为应用程序提供灵活的扩展和定制功能，应用程序使用Lua作为自己的嵌入式脚本语言，以此来实现可配置和可扩展。火焰病毒中的部分程序模块采用Lua脚本实现，根据分析，判断火焰病毒中有3000多行的Lua脚本代码量。</p><h3 id="2-6指挥控制服务器和蓝牙通信"><a href="#2-6指挥控制服务器和蓝牙通信" class="headerlink" title="2.6指挥控制服务器和蓝牙通信"></a>2.6指挥控制服务器和蓝牙通信</h3><p>火焰病毒根据配置文件中设置的指挥控制（C&amp;C）服务器的域名进行连接，当发现可以连接指挥控制服务器后，就会将获取的信息传送到指挥控制服务器上，并且从该服务器上获取相关的指令和配置。同时，火焰病毒在隔离网络间进行数据传送时还巧妙地利用了蓝牙通信技术――当检测到被感染的主机有蓝牙设备时，该病毒将打开蓝牙设备，检测周围有哪些可以连接的蓝牙设备，将检测到的信息记录在信息文件中；同时，该病毒还可以将被感染的主机设置为“beacon”（发送）模式，其他感染的主机通过蓝牙通信进行连接并传送数据。这样，两台主机即使在两个隔离的网络之间仍然可以通过蓝牙设备进行数据传输。</p></div><h2 id="三、火焰病毒的特点"><a href="#三、火焰病毒的特点" class="headerlink" title="三、火焰病毒的特点"></a>三、火焰病毒的特点</h2><div class="story post-story"><h3 id="3-1模块化程度高"><a href="#3-1模块化程度高" class="headerlink" title="3.1模块化程度高"></a>3.1模块化程度高</h3><p>火焰病毒中包含几十个模块，多数模块是可以配置或上传的。获取的火焰病毒主模块样本最大的有6MB，最小的只有900KB――最小的病毒样本开始执行后将通过网络下载所需的其他模块。另外，模块化程度高也便于病毒的升级更新。在该病毒潜伏的这些年中，虽然网络技术和Windows操作系统版本经过了几代的发展，但是由于病毒的开发者不断地研发出新的模块，上传到火焰病毒中，使该病毒技术领先、机制复杂、威胁程度高。</p><h3 id="3-2信息获取能力强"><a href="#3-2信息获取能力强" class="headerlink" title="3.2信息获取能力强"></a>3.2信息获取能力强</h3><p>火焰病毒根据配置，可以通过键盘记录、屏幕截取、麦克风录音、网络共享监测、存储介质遍历、移动介质监测、网络嗅探、无线网络（Wi-Fi）探测、蓝牙连接监视等手段获取各种敏感和机密信息，具有极强的信息获取能力。</p><h3 id="3-3渗透扩散能力强"><a href="#3-3渗透扩散能力强" class="headerlink" title="3.3渗透扩散能力强"></a>3.3渗透扩散能力强</h3><p>火焰病毒可以通过USB移动存储介质的autorun.inf、针对USB移动存储介质的MS10-046漏洞、针对Windows系统的MS10-061远程漏洞和补丁升级中间人攻击、SqlServer的远程工作任务、共享目录和域管理员权限等多种方法对局域网或隔离网络中其他主机进行渗透扩散。这些方法涉及移动介质、操作系统、数据库和域等多个层面。</p><h3 id="3-4可控性强"><a href="#3-4可控性强" class="headerlink" title="3.4可控性强"></a>3.4可控性强</h3><p>火焰病毒之所以能够潜伏这么长时间而不被发现，主要是由于其具有极强的可控性。当该病毒检测到可以连接互联网时，就将获取到的各种信息通过指挥控制（C&amp;C）服务器发送给病毒的操纵者；病毒的操纵者根据在目标网络中获取的信息，通过指挥控制服务器向火焰病毒传送包括加载功能模块、渗透扩展方式、信息获取方式、渗透扩展次数、自毁模块等配置，对火焰病毒的行为进行控制，这样可以在获取各种信息的同时最大程度地隐藏其行为，防止被发现。</p><h3 id="3-5自身防护能力强"><a href="#3-5自身防护能力强" class="headerlink" title="3.5自身防护能力强"></a>3.5自身防护能力强</h3><p>火焰病毒中包含防护软件探测模块，该模块可以对被感染主机安装的防护软件进行探测，能够根据主机的安全状况决定是否执行、如何生成附属文件的名称或者是否将火焰病毒从被感染主机上彻底清除。另外，火焰病毒采用了模块的“隐蔽”注入，使得其更加难以被发现。</p><h3 id="3-6数据机密性高"><a href="#3-6数据机密性高" class="headerlink" title="3.6数据机密性高"></a>3.6数据机密性高</h3><p>火焰病毒采用了三种数据压缩算法、五种加密算法和五种文件格式对病毒文件进行压缩加密处理，使得火焰病毒附属文件的机密性很高，通过常规的文件内容分析和扫描根本无法检测出与火焰病毒相关的敏感信息。</p></div><h2 id="发展及防护"><a href="#发展及防护" class="headerlink" title="发展及防护"></a>发展及防护</h2><div class="story post-story"><p>2019年中国互联网网络安全报告中说道：“2019年，在我国相关部门持续开展的网络安全威胁治理下，分布式拒绝服务攻击（以下简称DDoS攻击）、高级持续性威胁攻击（以下简称APT攻击）、漏洞威胁、数据安全隐患、移动互联网恶意程序、网络黑灰色产业链（以下简称黑灰产）、工业控制系统安全威胁总体下降，但呈现出许多新的特点，带来新的风险与挑战。”网络安全，不能有一丝懈怠。</p><p>与以往炮火纷飞的传统作战方式不同，网络战是一种隐蔽无声的全新作战方式，它不仅活跃在战争和各类冲突中，而且闪烁于平时的各种政治、经济、军事、文化和科技等活动中。不论是哪个国家和民族，要想立足未来，必须占领互联网这个制高点。</p><p>2017年4月13日，永恒之蓝漏洞被曝光，为大众所熟知，在该漏洞曝光后的一个月，5月12日，勒索病毒WannaCry利用永恒之蓝漏洞肆虐全球，以类似于蠕虫病毒的方式传播，攻击主机并加密主机上存储的文件，然后要求以比特币的形式支付赎金，据报道包括美国、英国、中国、俄罗斯、西班牙、意大利、越南等百余个国家均遭受大规模攻击。我国的许多行业机构和大型企业也被攻击，有的单位甚至“全军覆没”，损失之严重为近年来所罕见。至少150个国家、30万名用户中招，造成超80亿美元的损失。据火绒实验室技术分析追溯发现，该病毒分蠕虫部分及勒索病毒部分，前者用于传播和释放病毒，后者攻击用户加密文件。</p><p>火焰病毒具有蠕虫的特征，其主要特性是捕获数据和窃取信息，通过劫持Windows系统的升级程序，把自己安装在目标计算机上。升级程序本来自带数字签名和证书，以防止程序被篡改，但火焰病毒的制造者伪造了这个证书，说明其针对hash算法进行了碰撞攻击。</p><p>MD5是一种被广泛使用的hash函数。虽然王小云教授已经证明MD5是不安全的，但在我的记忆里，MD5碰撞攻击是非常复杂并且耗费大量时间和资源的。在看到火焰病毒竟然可以轻易仿造数字签名证书，我感到非常震撼。</p><p>通过了解火焰病毒的攻击原理，我觉得可以通过以下方式进行防护：</p><ul><li><p>安装安全防护软件，及时更新病毒数据库；</p></li><li><p>进一步加强企业内网安全建设，关闭主机中不必要的网络服务端口；</p></li><li><p>加强对口令以及移动存储设备的安全管理。</p></li></ul><p>此外，由于火焰病毒可以不知不觉的控制蓝牙，麦克风，摄像头等硬件设备，那我们要格外关注相对应的设备开关标志，比如大部分电脑的摄像头被使用时，旁边的小灯会亮起；麦克风被使用时，任务栏会有小话筒标志。</p><p>大数据背景下,计算机网络技术深刻影响着大众的生活、生产。人类的吃穿住行玩乐已经离不开互联网和信息，在信息化社会中，信息才是主宰，因此保护信息安全至关重要。现在中国相对稳定的安全环境中存在着不安全因素，“安而不忘危，存而不忘亡，治而不忘乱。”居安思危，思则有备，备则无患，在任何时刻都不能放松警惕。</p></div>]]></content>
      
      
      <categories>
          
          <category> 恶意代码防范 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 恶意代码防范 </tag>
            
            <tag> 病毒 </tag>
            
            <tag> 火焰 </tag>
            
            <tag> Flame </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>等级保护&amp;分级保护的联系与区别</title>
      <link href="/2022/03/25/%E7%AD%89%E7%BA%A7%E4%BF%9D%E6%8A%A4&amp;%E5%88%86%E7%BA%A7%E4%BF%9D%E6%8A%A4%E7%9A%84%E8%81%94%E7%B3%BB%E4%B8%8E%E5%8C%BA%E5%88%AB/"/>
      <url>/2022/03/25/%E7%AD%89%E7%BA%A7%E4%BF%9D%E6%8A%A4&amp;%E5%88%86%E7%BA%A7%E4%BF%9D%E6%8A%A4%E7%9A%84%E8%81%94%E7%B3%BB%E4%B8%8E%E5%8C%BA%E5%88%AB/</url>
      
        <content type="html"><![CDATA[<h1 id="等级保护-amp-分级保护的联系与区别"><a href="#等级保护-amp-分级保护的联系与区别" class="headerlink" title="等级保护&amp;分级保护的联系与区别"></a><strong>等级保护&amp;分级保护的联系与区别</strong></h1><h2 id="一、等级保护-amp-分级保护的不同定义"><a href="#一、等级保护-amp-分级保护的不同定义" class="headerlink" title="一、等级保护&amp;分级保护的不同定义"></a><strong>一、等级保护&amp;分级保护的不同定义</strong></h2><div class="story post-story"><h3 id="等级保护"><a href="#等级保护" class="headerlink" title="等级保护"></a><strong>等级保护</strong></h3><p>信息安全等级保护是指对国家秘密信息、法人和其他组织及公民的专有信息以及公开信息和储存、传输、处理这些信息的信息系统分等级实行安全保护，对信息系统中使用的信息安全产品实行按等级管理，对信息系统中发生的信息安全事件分等级响应、处置。</p><h3 id="分级保护"><a href="#分级保护" class="headerlink" title="分级保护"></a><strong>分级保护</strong></h3><p>涉密信息系统分级保护是指涉密信息系统的建设使用单位根据分级保护管理办法和有关标准，对涉密信息系统分等级实施保护，各级保密工作部门根据涉密信息系统的保护等级实施监督管理，确保系统和信息安全。</p></div><h2 id="二、等级保护与分级保护不同的适用对象-（本质区别）"><a href="#二、等级保护与分级保护不同的适用对象-（本质区别）" class="headerlink" title="二、等级保护与分级保护不同的适用对象  （本质区别）"></a><strong>二、等级保护与分级保护不同的适用对象</strong>  <strong>（本质区别）</strong></h2><div class="story post-story"><h3 id="等级保护-1"><a href="#等级保护-1" class="headerlink" title="等级保护"></a><strong>等级保护</strong></h3><p>国家安全信息等级保护是实施信息安全管理的一项法定制度，重点保护的对象是<strong>非涉密</strong>的涉及国计民生的重要信息系统和通信基础信息系统。</p><h3 id="分级保护-1"><a href="#分级保护-1" class="headerlink" title="分级保护"></a><strong>分级保护</strong></h3><p>涉密信息系统分级保护是国家信息安全等级保护的重要组成部分，是等级保护在<strong>涉密领域</strong>的具体体现。</p></div><h2 id="三、等级保护和分级保护不同的发起部门和主管部门"><a href="#三、等级保护和分级保护不同的发起部门和主管部门" class="headerlink" title="三、等级保护和分级保护不同的发起部门和主管部门"></a><strong>三、等级保护和分级保护不同的发起部门和主管部门</strong></h2><div class="story post-story"><h3 id="等级保护-2"><a href="#等级保护-2" class="headerlink" title="等级保护"></a><strong>等级保护</strong></h3><p>等级保护由<strong>公安部门发起</strong>，其主管单位及相应管理职责如下所示：</p><ul><li>公安机关：等级保护工作的主管部门，负责信息安全等级保护工作的<strong>监督、检查、指导</strong>；</li><li>国家保密工作部门：负责等级保护工作中有关<strong>保密工作的监督、检查、指导</strong>；</li><li>国家密码管理部门：负责等级保护工作中有关<strong>密码工作的监督、检查、指导</strong>；</li><li>国务院信息办（国信办）及地方信息化领导小组办事机构：负责等级保护工作<strong>部门间的协调</strong>，涉及国家秘密信息系统的等级保护监督管理工作由国家保密工作部门负责。</li></ul><h3 id="分级保护-2"><a href="#分级保护-2" class="headerlink" title="分级保护"></a><strong>分级保护</strong></h3><p>分级保护由<strong>国家保密局发起</strong>，其主管单位及相应管理职责如下所示：</p><ul><li>国家保密局：<strong>监督，检查，指导；</strong></li><li>地方各级保密局：<strong>监督，检查，指导；</strong></li><li>中央和国家机关(本部门)：<strong>主管和指导；</strong></li><li>建设使用单位：<strong>具体实施。</strong></li></ul></div><h2 id="四、等级保护和分级保护不同的政策依据"><a href="#四、等级保护和分级保护不同的政策依据" class="headerlink" title="四、等级保护和分级保护不同的政策依据"></a><strong>四、等级保护和分级保护不同的政策依据</strong></h2><div class="story post-story"><h3 id="等级保护政策依据"><a href="#等级保护政策依据" class="headerlink" title="等级保护政策依据"></a><strong>等级保护政策依据</strong></h3><p>《中华人民共和国计算机信息系统安全保护条例》（国务院147号令，1994年）；</p><p>《国家信息化领导小组关于加强信息安全保障工作的意见》（中办发[2003]27号）；</p><p>《关于信息安全等级保护工作的实施意见》（公通字[2004]66号）；</p><p>《信息安全等级保护管理办法》（公通字[2007]43号）；</p><p>《关于开展全国重要信息系统安全等级保护定级工作的通知》（公信安[2007]861号）；</p><p>《关于加强国家电子政务工程建设项目信息安全风险评估工作的通知》(发改高技[2008]2071号)。</p><h3 id="分级保护政策依据"><a href="#分级保护政策依据" class="headerlink" title="分级保护政策依据"></a><strong>分级保护政策依据</strong></h3><p>《关于加强信息安全保障工作中保密管理的若干意见》（中保委发[2004]7号）；</p><p>《涉及国家秘密的信息系统分级保护管理办法》（国保发[2005]16号）。</p></div><h2 id="五、标准体系"><a href="#五、标准体系" class="headerlink" title="五、标准体系"></a><strong>五、标准体系</strong></h2><div class="story post-story"><h3 id="等级保护-3"><a href="#等级保护-3" class="headerlink" title="等级保护"></a><strong>等级保护</strong></h3><p>国家标准（GB、GB&#x2F;T）</p><h3 id="分级保护-3"><a href="#分级保护-3" class="headerlink" title="分级保护"></a><strong>分级保护</strong></h3><p>国家保密标准（BMB,强制执行）</p></div><h2 id="六、系统定级"><a href="#六、系统定级" class="headerlink" title="六、系统定级"></a><strong>六、系统定级</strong></h2><div class="story post-story"><h3 id="等级保护-4"><a href="#等级保护-4" class="headerlink" title="等级保护"></a><strong>等级保护</strong></h3><p>信息系统的安全保护等级应当根据信息系统在国家安全、经济建设、社会生活中的重要程度，信息系统遭到破坏后对国家安全、社会秩序、公共利益以及公民、法人和其他组织的合法权益的危害程度等因素确定，由低到高划分为五个等级：<strong>第一级（自主保护）、第二级（指导保护）、第三级（监督保护）、第四级（强制保护）、第五级（专控保护）。</strong></p><h3 id="分级保护-4"><a href="#分级保护-4" class="headerlink" title="分级保护"></a><strong>分级保护</strong></h3><p>涉密信息系统按照所处理信息的最高密级，由低到高划分为<strong>秘密、机密和绝密</strong>三个等级</p><h3 id="之间的联系（对应关系）"><a href="#之间的联系（对应关系）" class="headerlink" title="之间的联系（对应关系）"></a><strong>之间的联系（对应关系）</strong></h3><p>涉密信息系统建设使用单位应当依据涉密信息系统分级保护管理规范和技术标准，按照<strong>秘密、机密、绝密</strong>三级的不同要求, 结合系统实际进行方案设计，实施分级保护，其保护水平总体上不低于国家信息安全等级保护<strong>第三级、第四级、第五级</strong>的水平。</p><p>秘密级对应三级、机密级对应四级、绝密级对应五级。</p></div><h2 id="七、工作内容"><a href="#七、工作内容" class="headerlink" title="七、工作内容"></a><strong>七、工作内容</strong></h2><div class="story post-story"><p>等级保护工作包括<strong>系统定级、系统备案、安全建设整改、等级测评和监督检查</strong>五个环节。</p><p>分级保护工作包括<strong>系统定级、方案设计、工程实施、系统测评、系统审批、日常管理、测评与检查、系统废止</strong>八个环节。</p></div><h2 id="八、测评频率"><a href="#八、测评频率" class="headerlink" title="八、测评频率"></a><strong>八、测评频率</strong></h2><div class="story post-story"><h3 id="等级保护各级别测评频率："><a href="#等级保护各级别测评频率：" class="headerlink" title="等级保护各级别测评频率："></a><strong>等级保护各级别测评频率：</strong></h3><ul><li><p>第二级信息系统：应<strong>每两年</strong>至少进行一次等级测评；</p></li><li><p>第三级信息系统：应<strong>每年</strong>至少进行一次等级测评；</p></li><li><p>第四级信息系统：应<strong>每半年</strong>至少进行一次等级测评。</p></li><li><p>第一级信息系统不需测评。</p></li><li><p>第五级信息系统一般适用于国家重要领域、重要部门中的极端重要系统，特殊行业特殊要求，不在等保测评机构的测评范畴。<strong>应当根据特殊安全要求进行等级测评。</strong></p></li></ul><h3 id="分级保护各级别测评频率："><a href="#分级保护各级别测评频率：" class="headerlink" title="分级保护各级别测评频率："></a><strong>分级保护各级别测评频率：</strong></h3><ul><li><p>秘密级、机密级信息系统：应<strong>每两年至少进行一次</strong>安全保密测评或保密检查；</p></li><li><p>绝密级信息系统：应<strong>每年至少进行一次</strong>安全保密测评或保密检查。</p></li></ul></div><h2 id="九、测评机构资质要求"><a href="#九、测评机构资质要求" class="headerlink" title="九、测评机构资质要求"></a><strong>九、测评机构资质要求</strong></h2><div class="story post-story"><p>等级保护测评机构资质由<strong>国家信息安全等级保护工作协调小组办公室</strong>授予。</p><p>分级保护测评机构资质由<strong>国家保密工作部门</strong>授予。</p></div>]]></content>
      
      
      <categories>
          
          <category> 保密技术概论 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 等级保护 </tag>
            
            <tag> 分级保护 </tag>
            
            <tag> 保密 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
